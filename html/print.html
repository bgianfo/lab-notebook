<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Brian&#x27;s Lab Notebook</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="background.html"><strong aria-hidden="true">1.</strong> Background</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Notes</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="notes/2020-12-29.html"><strong aria-hidden="true">2.1.</strong> 2020-12-29: Lab Notebook Setup</a></li><li class="chapter-item expanded "><a href="notes/2020-12-29-gpg-signing.html"><strong aria-hidden="true">2.2.</strong> 2020-12-29: Commit Signing</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> SerenityOS</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="serenityos/2022-01-16.html"><strong aria-hidden="true">3.1.</strong> 2022-01-06: ftrivial-auto-var-init</a></li><li class="chapter-item expanded "><a href="serenityos/2021-01-02.html"><strong aria-hidden="true">3.2.</strong> 2021-01-02: KASAN Research</a></li><li class="chapter-item expanded "><a href="serenityos/2021-01-01.html"><strong aria-hidden="true">3.3.</strong> 2021-01-01: Stack Canaries</a></li><li class="chapter-item expanded "><a href="serenityos/2020-12-30.html"><strong aria-hidden="true">3.4.</strong> 2020-12-30: CodeQL Queries</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> PolarFire SOC Icicle</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="polarfire/2020-11-26.html"><strong aria-hidden="true">4.1.</strong> 2020-11-26: Initial Setup</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Brian&#x27;s Lab Notebook</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="http://github.com/bgianfo/lab-notebook" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="lab-notebook-background"><a class="header" href="#lab-notebook-background">Lab Notebook Background</a></h1>
<p>Welcome to my lab notebook, where I keep my public working notes, and any
tips or tricks that I discover.</p>
<p>The idea for this &quot;lab notebook&quot; was inspired by:</p>
<ul>
<li><a href="https://twitter.com/whitequark">@whitequark</a> - <a href="https://lab.whitequark.org/">lab.whitequark.org</a></li>
<li><a href="https://twitter.com/bitshiftmask">@bitshiftmask</a> - <a href="https://lab.jamesmunns.com/">lab.jamesmunns.com</a> </li>
</ul>
<p>It's built with <a href="https://github.com/rust-lang/mdBook">mdbook</a> and automatically
published with <a href="https://github.com/marketplace/actions/mdbook-action">mdbook-action</a>.
You can read more about how I setup the notebook in the <a href="./notes/2020-12-29.html">2020-12-19 - Lab Notebook Setup</a>
note. The source is available at <a href="https://github.com/bgianfo/lab-notebook">bgianfo/lab-notebook</a>.
Please feel free to send pull requests if you see anything that's incorrect!</p>
<p>If you want to get in touch with me check out <a href="https://bjg.io/about/">bjg.io/about</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="12-29-2020-lab-notebook-setup"><a class="header" href="#12-29-2020-lab-notebook-setup">12-29-2020: Lab Notebook Setup</a></h1>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>I've noticed a few people whom I follow and admire online have started to keep lab notebooks.
I first ran across the idea when I saw <a href="https://twitter.com/whitequark">@whitequark</a>'s notebook <a href="https://lab.whitequark.org/">lab.whitequark.org</a>,
and then this evening I ran across <a href="https://twitter.com/bitshiftmask">@bitshiftmask</a>'s <a href="https://lab.jamesmunns.com/">lab.jamesmunns.com</a> by chance
and saw they were doing a similar thing with <a href="https://github.com/rust-lang/mdBook">mdbook</a> which seems very easy to use and straight forward to setup and maintain.</p>
<p>I've been on a personal knowledge management kick recently, and I've been playing whit <a href="https://obsidian.md/">obsidian.md</a> for maintaining a 'second brain'.
The idea of a public lab notebook seems like an interesting idea that I want to play with. So this first post is going to be the process of setting this up.</p>
<h2 id="boot-strapping-the-book"><a class="header" href="#boot-strapping-the-book">Boot Strapping The Book</a></h2>
<p>To get started with the notebook first I created a new GitHub repository <a href="https://github.com/bgianfo/lab-notebook/">github.com/bgianfo/lab-notebook</a>.
Then I configured my lab notebook <code>mdbook</code> project just enough so that this page building.</p>
<pre><code class="language-bash">C:\src\lab-notebook&gt;tree /A /F
|   .gitignore
|   book.toml
|   README.md
|
\---src
    |   SUMMARY.md
    |
    \---notes
            2020-12-29.md
</code></pre>
<p>Once we have the shell of the project setup and can use <code>mdbook serve</code> to have the system automatically rebuild and refresh pages as we edit them:</p>
<pre><code class="language-bash">C:\src\lab-notebook&gt;mdbook serve
2020-12-29 03:02:15 [INFO] (mdbook::book): Book building has started
2020-12-29 03:02:15 [INFO] (mdbook::book): Running the html backend
2020-12-29 03:02:15 [INFO] (mdbook::cmd::serve): Serving on: http://localhost:3000
2020-12-29 03:02:15 [INFO] (warp::server): Server::run; addr=[::1]:3000
2020-12-29 03:02:15 [INFO] (warp::server): listening on http://[::1]:3000
2020-12-29 03:02:15 [INFO] (mdbook::cmd::watch): Listening for changes...
2020-12-29 03:02:22 [INFO] (mdbook::cmd::serve): Files changed: [&quot;notes\2020-12-29.md&quot;]
2020-12-29 03:02:22 [INFO] (mdbook::cmd::serve): Building book...
2020-12-29 03:02:22 [INFO] (mdbook::book): Book building has started
2020-12-29 03:02:22 [INFO] (mdbook::book): Running the html backend
</code></pre>
<h2 id="publishing"><a class="header" href="#publishing">Publishing</a></h2>
<p>Now that we have the basics of the book building, I want to get the notebook
published, and served off of my subdomain <a href="https://lab.bjg.io">lab.bjg.io</a> where
nothing currently resides today. To make this as pain free as possible I was hoping
to use <strong>github pages</strong> for this, the same as the rest of my site. When poking around
I found the <a href="https://github.com/marketplace/actions/mdbook-action">mdbook-action</a>
which allows you to painlessly publish your mdbook from a github actions workflow.</p>
<p>Following the documentation I was able to create a <a href="https://github.com/bgianfo/lab-notebook/commit/324781fae79572ea954d9bb5f8bd103b5c808e1b#diff-28802fbf11c83a2eee09623fb192785e7ca92a3f40602a517c011b947a1822d3">simple workflow (324781fae)</a>:</p>
<pre><code class="language-yaml">name: Publish To GitHub Pages

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2

      - name: Setup mdBook
        uses: peaceiris/actions-mdbook@v1
        with:
          mdbook-version: 'latest'

      - run: mdbook build

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./book
</code></pre>
<p>I looked for signs that the action ran, and nothing... so double checking the pipeline
I realized that GitHub created the new default branch as <code>main</code>, not <code>master</code>. So our
pipeline wasn't running because we are listening for push events on the wrong branch.
Announcement: <a href="https://github.com/github/renaming">https://github.com/github/renaming</a></p>
<p>So we need one small change to our pipeline to fix things up:</p>
<pre><code class="language-diff">commit 78fd8a787cf6a2f49eca8e402eb6aede9caad174
Author: Brian Gianforcaro &lt;b.gianfo@gmail.com&gt;
Date:   Tue Dec 29 03:17:52 2020 -0800

    CI: Fix to modern branch name

diff --git a/.github/workflows/deploy.yml b/.github/workflows/deploy.yml
index cf0fa96..7707376 100644
--- a/.github/workflows/deploy.yml
+++ b/.github/workflows/deploy.yml
@@ -3,7 +3,7 @@ name: Publish To GitHub Pages
 on:
   push:
     branches:
-      - master
+      - main
</code></pre>
<p>That worked and automatically created a new <code>gh-pages</code> branch in the repository.
In the GitHub repository settings I was then able to configure <strong>github pages</strong>
to use the new gh-pages branch. See: <a href="https://docs.github.com/en/free-pro-team@latest/github/working-with-github-pages/managing-a-custom-domain-for-your-github-pages-site">GitHub Docs: Managing a custom domain for your GitHub Pages site</a></p>
<p>I then configured github pages to publish under a custom domain (lab.bjg.io), this
will automatically create a new <a href="https://github.com/bgianfo/lab-notebook/commit/5a85fb76a5d87e720913c3ae8d92be26387abf1d">CNAME</a>
file in the root of your project. Next I  went to by DNS provider and added a new 
<strong>CNAME</strong> record to my domain configuration pointing <code>lab.bjg.io -&gt; bgianfo.github.io</code>.</p>
<p>And Voila! It Alive!</p>
<p>Well kind of ... As soon as I pushed new changes, the sub domain no longer works.
That is very strange?</p>
<p>After some digging in the CI logs, I realized that the <code>actions-gh-pages</code> action was
deleting the CNAME file in the gh-pages branch on every push, breaking the configuration.
I looked through the docs for the gh-pages action and found they have their own
option for auto generating the CNAME file from within the action. So I made a
small change to use that option:</p>
<pre><code class="language-diff">commit 2f5c50ad033f4db4401ba7ddf427306ed326ab2e
Author: Brian Gianforcaro &lt;b.gianfo@gmail.com&gt;
Date:   Tue Dec 29 04:10:11 2020 -0800

    CI: Configure CNAME when generating html and publishing to gh-pages

diff --git a/.github/workflows/deploy.yml b/.github/workflows/deploy.yml
index 7707376..1364391 100644
--- a/.github/workflows/deploy.yml
+++ b/.github/workflows/deploy.yml
@@ -23,3 +23,4 @@ jobs:
         with:
           github_token: ${{ secrets.GITHUB_TOKEN }}
           publish_dir: ./book
+          cname: lab.bjg.io
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-commit-signing-with-keybase"><a class="header" href="#git-commit-signing-with-keybase">Git Commit Signing with Keybase</a></h1>
<p>I already have a <a href="https://keybase.io/bjg">keybase</a> account.
I've been interested in getting git commit signing setup with my keybase pgp key.
I quickly found a nice guide that worked well.
See: <a href="https://meedamian.com/post/keybase-signed-github/">https://meedamian.com/post/keybase-signed-github</a></p>
<p>After following the guide, git now shows my commits as signed.
Example:</p>
<pre><code class="language-diff">bgianf@LMAO:~/src/lab-notebook/src$ git log --show-signature -1
commit be372efa95c64ef4a71e2b06e69baf47d275923f (HEAD -&gt; main, origin/main, origin/HEAD)
gpg: Signature made Tue Dec 29 21:14:34 2020 PST
gpg:                using RSA key 899C11E2EEAA2EEE43775D148802D4B232E81AFA
gpg: checking the trustdb
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
gpg: Good signature from &quot;Brian Gianforcaro (http://bjg.io) &lt;b.gianfo@gmail.com&gt;&quot; [ultimate]
gpg:                 aka &quot;keybase.io/bjg &lt;bjg@keybase.io&gt;&quot; [ultimate]
Author: Brian Gianforcaro &lt;b.gianfo@gmail.com&gt;
Date:   Tue Dec 29 21:12:47 2020 -0800

    Notes: Add note about signing commits with keybase pgp keys
</code></pre>
<p>GitHub displays these with the <strong>VERIFIED</strong> qualifier.</p>
<p>See: <a href="https://github.com/bgianfo/lab-notebook/commit/be372efa95c64ef4a71e2b06e69baf47d275923f">https://github.com/bgianfo/lab-notebook/commit/be372efa95c64ef4a71e2b06e69baf47d275923f</a></p>
<p>Nice!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="compiling-serenityos-kernel-with--ftrivial-auto-var-init"><a class="header" href="#compiling-serenityos-kernel-with--ftrivial-auto-var-init">Compiling SerenityOS Kernel with -ftrivial-auto-var-init</a></h1>
<h2 id="introduction-1"><a class="header" href="#introduction-1">Introduction</a></h2>
<p>In recent years the industry has collectively decided that it's probably time
we do something to address the various bugs that can occur from uninitialized
stack memory. A few examples of bug classes that can originate from uninitialized
stack memory include:</p>
<ul>
<li>
<p>Kernel information disclosure, where uninitialized struct members or
struct padding is copied back to usermode, leaking kernel information such
as stack or heap addresses, or secret data like stack cookies.</p>
</li>
<li>
<p>Control flow based on uninitialized memory can cause a variety of issues at
at runtime, including stack corruptions like buffer overflows, heap corruptions
due to deleting stray pointers. Even basic logic bugs can result from control
flow operating on uninitialized data.</p>
</li>
</ul>
<p><strong>TODO: Add more history from the &quot;Automatic initialization of variables section https://isopenbsdsecu.re/mitigations/missing_features/</strong></p>
<p>In 2018 <a href="https://reviews.llvm.org/D54604">JF Bastien contributed &quot;Automatic variable initialization&quot; to LLVM</a>
and later presented that work in 2019 with his <a href="https://www.youtube.com/watch?v=I-XUHPimq3o">&quot;Mitigating Undefined Behavior&quot;</a>
talk at the LLVM Developers Meeting.</p>
<p>At CppCon 2019 <a href="https://www.youtube.com/watch?v=rQWjF8NvqAU">Joe Bialek and Shayne Hiet-Block presented their
&quot;Killing Uninitialized Memory: Protecting the OS Without Destroying Performance”</a>
talk which describes the <code>/initAll</code> mechanism that was <a href="https://msrc-blog.microsoft.com/2020/05/13/solving-uninitialized-stack-memory-on-windows/">built into the MSVC compiler</a>
and integrated into the windows build system to combat uninitialized stack memory bugs
throughout the windows kernel and hyper visor stack.</p>
<p>SerenityOS attempts to employ a variety of <a href="https://github.com/SerenityOS/serenity/blob/master/Base/usr/share/man/man7/Mitigations.md">security mitigations</a> to harden
the system against would be attackers. I was interested in pursuing some sort
of stack zeroing mechanism to mitigate this entire bug class in the SerenityOS
kernel. SerenityOS utilizes GCC (version 11.2 at the time of writing) as it's
primary toolchain, with secondary support for Clang+LLVM available as well. </p>
<p>So I started researching what options were available for GCC.</p>
<h2 id="forward-porting"><a class="header" href="#forward-porting">Forward porting...</a></h2>
<p>With a little bit of effort I was able to backport the GCC <code>-ftrivial-auto-var-init</code>
feature and the subsequent related fixes to the SerenityOS GCC 11.2 toolchain.</p>
<p>First we needed the <a href="https://gcc.gnu.org/git/?p=gcc.git;a=commit;h=a25e0b5e6ac8a77a71c229e0a7b744603365b0e9">original commit</a> which contains the majority of the implementation.</p>
<pre><code>commit cd5638353ee77f6c5c072f6ca9a19d77ad2f2bf8
Author: Brian Gianforcaro &lt;bgianf@serenityos.org&gt;
Date:   Sat Sep 11 08:27:12 2021 -0700

    Toolchain: Backport -ftrivial-auto-var-init to our GCC 11.2 toolchain

    This change back ports the patch to support -ftrivial-auto-var-init so
    that it compiles on top of the 11.2 release. It was originally committed
    to target the GCC 12 release cycle. The back porting was just fixing up
    patch collisions, no major surgery was needed.
</code></pre>
<p>When trying to compile Serenity with a newly built toolchain with just the first patch
applied I immediately ran into an ICE (Internal Compiler Error). I put the project on hold
for a few days and decided to see if the issue had been reported upstream already. Much to
my surprise it had, and there was already a <a href="https://gcc.gnu.org/git/?p=gcc.git;a=commit;h=a21bd3cebd6f54af70a37c18b8fbeae933fb6515">fix available in the GCC development branch</a>.</p>
<details>
  <summary>Toolchain: Backport `__builtin_clear_padding` fix to gcc 11.2</summary>
<pre><code>commit 463ce32c0edd689f56b619a9eeabc77cc44b528c
Author: Brian Gianforcaro &lt;bgianf@serenityos.org&gt;
Date:   Sun Oct 3 03:07:40 2021 -0700

    Toolchain: Backport '__builtin_clear_padding' fix to gcc 11.2

    This change backports a fix for a bug which previously would cause us
    to ICE when compiling the Kernel, with this patch we continue chugging
    along.
</code></pre>
</details>
<p>While investigating I also <a href="https://gcc.gnu.org/git/?p=gcc.git;a=commit;h=1dae802b685937b1dc52e49d0641c75f3186ba14">found a few</a> other <a href="https://gcc.gnu.org/git/?p=gcc.git;a=commitdiff;h=79f488de3036a4a4be08df2a782e6eb02419db19">ICE fixes</a> that it looked like we should
really have if we were going to ever merge this to master, so I took care of porting those as well.</p>
<details>
  <summary>Toolchain: Backport 'avoid auto-init of empty types' fix to gcc 11.2</summary>
<pre><code>commit 8ddf95bb4fc61482fda8d7460c208c43873131ab
Author: Brian Gianforcaro &lt;bgianf@serenityos.org&gt;
Date:   Sat Sep 11 09:05:07 2021 -0700

    Toolchain: Backport 'avoid auto-init of empty types' fix to gcc 11.2

    This is a follow up fix to the main `-ftrivial-auto-var-init` patch
    that we need as well. This patch didn't require any work to apply.
</code></pre>
</details>
<details>
  <summary>Toolchain: Backport 'avoid ICE with auto-init and nested functions' fix</summary>
<pre><code>commit 41ec4ff60a0e5d04171631ccdadeeb147a4e86aa
Author: Brian Gianforcaro &lt;bgianf@serenityos.org&gt;
Date:   Sat Sep 11 09:14:53 2021 -0700

    Backport 'avoid ICE with auto-init and nested functions' fix
    

    This is a follow up fix to the main `-ftrivial-auto-var-init` patch
    that we need as well. This patch didn't require any work to apply.
</code></pre>
</details>
<p>After finding all the fixes I needed to backport in order to get the system to
actually build without crashing the compiler, I was eager to try it out.
The following patch is all that was needed to integrate the new compiler flag
into the SerenityOS Kernel build system.</p>
<pre><code class="language-diff">commit bf59bf2d0fb3e3b7745e60ddde715a175d7b1c3d
Author: Brian Gianforcaro &lt;bgianf@serenityos.org&gt;
Date:   Sat Sep 11 09:17:06 2021 -0700

    CMake: Enable `-ftrivial-auto-init=pattern` in the Kernel

diff --git a/Kernel/CMakeLists.txt b/Kernel/CMakeLists.txt
index 1f1c529018..ffd067d289 100644
--- a/Kernel/CMakeLists.txt
+++ b/Kernel/CMakeLists.txt
@@ -409,6 +409,10 @@ if (CMAKE_CXX_COMPILER_ID STREQUAL &quot;GNU&quot;)
     if (CMAKE_CXX_COMPILER_VERSION VERSION_GREATER_EQUAL &quot;11.1&quot;)
         # Zero any registers used within a function on return (to reduce data lifetime and ROP gadgets).
         add_compile_options(-fzero-call-used-regs=used-gpr)
+
+        # Auto initialize trivial types on the stack. Note: This isn't natively supported by the GCC 11 series.
+        # It was back ported for serenity, see Toolchain/Patches/gcc-ftrivial-auto-var-init.patch
+        add_compile_options(-ftrivial-auto-var-init=pattern)
     endif()
     link_directories(${TOOLCHAIN_ROOT}/${SERENITY_ARCH}-pc-serenity/lib)
     link_directories(${TOOLCHAIN_ROOT}/lib/gcc/${SERENITY_ARCH}-pc-serenity/${GCC_VERSION}/)
diff --git a/Kernel/Prekernel/CMakeLists.txt b/Kernel/Prekernel/CMakeLists.txt
index dbf1d8be8f..bf361e1aa2 100644
--- a/Kernel/Prekernel/CMakeLists.txt
+++ b/Kernel/Prekernel/CMakeLists.txt
@@ -88,4 +88,5 @@ install(FILES &quot;${CMAKE_CURRENT_BINARY_DIR}/Prekernel&quot; DESTINATION boot)
 get_target_property(PREKERNEL_TARGET_OPTIONS ${PREKERNEL_TARGET} COMPILE_OPTIONS)
 list(REMOVE_ITEM PREKERNEL_TARGET_OPTIONS &quot;-fsanitize-coverage=trace-pc&quot;)
 list(REMOVE_ITEM PREKERNEL_TARGET_OPTIONS &quot;-fsanitize=kernel-address&quot;)
+list(REMOVE_ITEM PREKERNEL_TARGET_OPTIONS &quot;-ftrivial-auto-var-init=pattern&quot;)
 set_target_properties(${PREKERNEL_TARGET} PROPERTIES COMPILE_OPTIONS &quot;${PREKERNEL_TARGET_OPTIONS}&quot;)
</code></pre>
<h2 id="investigation"><a class="header" href="#investigation">Investigation</a></h2>
<p>After booting the system and seeing it crash, I attached a debugger to QEMU and saw
that we now have a Undefined Behavior Sanitizer crash on startup while detecting 
which processor features are available. </p>
<pre><code class="language-cpp">(gdb) bt
#0  __ubsan_handle_type_mismatch_v1 (data=..., ptr=...)
#1  0xc1460d63 in operator() (f=..., __closure=...)
#2  Kernel::Processor::cpu_detect (this=...)
#3  0xc1461a4d in Kernel::Processor::cpu_setup (this=...)
#4  0xc1462f39 in Kernel::Processor::early_initialize (this=..., cpu=...)
#5  0xc145e886 in Kernel::init (boot_info=...)
#6  0x0010309d in Kernel::init ()
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="research-into-kasan-in-serenityos"><a class="header" href="#research-into-kasan-in-serenityos">Research into KASAN in SerenityOS</a></h1>
<h2 id="introduction-2"><a class="header" href="#introduction-2">Introduction</a></h2>
<p>Kernel Address Sanitizer (KASAN) is a dynamic analysis technology to find
dynamic memory errors in OS Kernels. It's based on instrumentation injected
by the compiler which checks all memory accesses made during execution.</p>
<p>I'm interested in enabling KASAN for <a href="https://github.com/SerenityOS/serenity">SerenityOS</a></p>
<p><strong>Links:</strong></p>
<ul>
<li><a href="https://www.kernel.org/doc/html/latest/dev-tools/kasan.html">Linux KASAN Docs</a></li>
<li><a href="https://events.static.linuxfound.org/sites/events/files/slides/LinuxCon%20North%20America%202015%20KernelAddressSanitizer.pdf">Linux KASAN Presentation</a></li>
<li><a href="https://lwn.net/Articles/612153/">LWN &quot;The kernel address santizer&quot;</a></li>
<li><a href="https://blog.netbsd.org/tnf/entry/kernel_address_sanitizer_part_3">NetBSD KASAN Blog</a></li>
<li><a href="https://netbsd.org/%7Ekamil/eurobsdcon2018_ksanitizers.html">NetBSD KASAN Presentation</a></li>
</ul>
<p>Here's the NetBSD presentation:</p>
<iframe align="center" width="900" height="535" src="https://www.youtube-nocookie.com/embed/capbD_aRz40" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<h2 id="lets-start-hacking"><a class="header" href="#lets-start-hacking">Lets start hacking!</a></h2>
<p>So my first attempt at doing anything was to just throw in <code>-fsanitize=kernel-address</code> and see
what falls out. Here's the first diff:</p>
<pre><code class="language-diff">diff --git a/Kernel/CMakeLists.txt b/Kernel/CMakeLists.txt
index 451060bf2..c7d9e5bec 100644
--- a/Kernel/CMakeLists.txt
+++ b/Kernel/CMakeLists.txt
@@ -268,6 +268,7 @@ set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -pie -fPIE -fno-rtti -ffreestanding -fbu
 set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -mno-80387 -mno-mmx -mno-sse -mno-sse2&quot;)
 set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -fno-asynchronous-unwind-tables&quot;)
 set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -fstack-protector-strong&quot;)
+set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -fsanitize=kernel-address&quot;)
 set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -nostdlib -nostdinc -nostdinc++&quot;)

 add_link_options(LINKER:-T ${CMAKE_CURRENT_BINARY_DIR}/linker.ld -nostdlib)
</code></pre>
<p>We compile successfully with the new flag, but we fail to link.
The linker complains about about a bunch of missing <strong>__asan_load{n}_noabort</strong> functions.</p>
<pre><code>... snip ...
./Build/Kernel/././AK/OwnPtr.h:140: undefined reference to `__asan_load4_noabort'
./Build/Kernel/././AK/NonnullOwnPtr.h:124: undefined reference to `__asan_load4_noabort'
./Build/Kernel/././Kernel/VM/RangeAllocator.h:48: undefined reference to `__asan_load4_noabort'
./Build/Kernel/././AK/OwnPtr.h:116: undefined reference to `__asan_handle_no_return'
./Build/Kernel/././AK/NonnullOwnPtr.h:124: undefined reference to `__asan_load4_noabort'
./Build/Kernel/././Kernel/VM/RangeAllocator.h:48: undefined reference to `__asan_load4_noabort'
./Build/Kernel/././AK/NonnullOwnPtr.h:124: undefined reference to `__asan_load4_noabort'
./Build/Kernel/././Kernel/VM/RangeAllocator.h:49: undefined reference to `__asan_load4_noabort'

... snip ...
</code></pre>
<p>Looking at NetBSD's implementation of KASAN shows that they have common handler macros for these functions.</p>
<p>Excerpt from <a href="https://github.com/NetBSD/src/blob/86e39537781864530a5ad72a7bfebfda434bd37e/sys/kern/subr_asan.c#L1182-L1202"><code>sys/kern/subr_asan.c</code></a>:</p>
<pre><code class="language-cpp">#define ASAN_LOAD_STORE(size)                   \
    void __asan_load##size(unsigned long);          \
    void __asan_load##size(unsigned long addr)      \
    {                           \
        kasan_shadow_check(addr, size, false, __RET_ADDR);\
    }                           \
    void __asan_load##size##_noabort(unsigned long);    \
    void __asan_load##size##_noabort(unsigned long addr)    \
    {                           \
        kasan_shadow_check(addr, size, false, __RET_ADDR);\
    }                           \
    void __asan_store##size(unsigned long);         \
    void __asan_store##size(unsigned long addr)     \
    {                           \
        kasan_shadow_check(addr, size, true, __RET_ADDR);\
    }                           \
    void __asan_store##size##_noabort(unsigned long);   \
    void __asan_store##size##_noabort(unsigned long addr)   \
    {                           \
        kasan_shadow_check(addr, size, true, __RET_ADDR);   \
    }
</code></pre>
<p>I guess I'll need to stub out these symbols for serenity when I get time to work on this further.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="enabling-stack-canaries-for-serenityos"><a class="header" href="#enabling-stack-canaries-for-serenityos">Enabling stack canaries for SerenityOS</a></h1>
<h2 id="introduction-3"><a class="header" href="#introduction-3">Introduction</a></h2>
<p>I've been looking into beefing up static and dynamic analysis available in
<a href="http://www.serenityos.org">SerenityOS</a>. One of the most basic things that
wasn't enabled yet was GCC's <code>-fstack-protector</code> feature, which automatically
inserts a <a href="https://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries">stack canary</a>
in the epilog of all functions.</p>
<p><a href="https://wiki.osdev.org/Stack_Smashing_Protector">osdev-wiki: Stack Smashing Protector</a></p>
<h2 id="which-variant-to-use"><a class="header" href="#which-variant-to-use">Which variant to use?</a></h2>
<p>There are three different variants of <code>-fstack-protector</code>, each with different
pros and cons. <a href="https://twitter.com/kees_cook">Kees Cook</a> has a nice writeup on
the specifics of <code>-fstack-protector-strong</code> and it's design on his <a href="https://outflux.net/blog/archives/2014/01/27/fstack-protector-strong/">blog</a>.</p>
<p>The <a href="https://www.keil.com/support/man/docs/armclang_ref/armclang_ref_cjh1548250046139.htm">ARM Clang Compiler Reference Guide</a>
has a nice overview of the different variants of <code>-fstack-protector</code> and their impact.</p>
<pre><code>-fno-stack-protector disables stack protection.

-fstack-protector enables stack protection for vulnerable functions that contain:

* A character array larger than 8 bytes.
* An 8-bit integer array larger than 8 bytes.
* A call to alloca() with either a variable size or a constant size bigger
  than 8 bytes.

-fstack-protector-all adds stack protection to all functions regardless of
 their vulnerability

-fstack-protector-strong enables stack protection for vulnerable functions
 that contain:

* An array of any size and type.
* A call to alloca().
* A local variable that has its address taken
</code></pre>
<p>It appears to me that <code>-fstack-protector-strong</code> would be great compromise for
Serenity OS.</p>
<h2 id="bootstrapping-the-implementation"><a class="header" href="#bootstrapping-the-implementation">Bootstrapping the Implementation</a></h2>
<p>The actual change to the build system is (of course) very simple:</p>
<pre><code class="language-diff">diff --git a/CMakeLists.txt b/CMakeLists.txt
index 7597e97fab..df039d3f82 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -125,9 +125,7 @@ if (CMAKE_SYSTEM_NAME MATCHES Darwin)
     set(CMAKE_SKIP_RPATH TRUE)
 endif()
 
-#FIXME: -fstack-protector
-
-add_compile_options(-Os -g1 -fno-exceptions -Wno-address-of-packed-member -Wundef -Wcast-qual -Wwrite-strings -Wimplicit-fallthrough -Wno-nonnull-compare -Wno-deprecated-copy -Wno-expansion-to-defined)
+add_compile_options(-Os -g1 -fno-exceptions -fstack-protector-strong -Wno-address-of-packed-member -Wundef -Wcast-qual -Wwrite-strings -Wimplicit-fallthrough -Wno-nonnull-compare -Wno-deprecated-copy -Wno-expansion-to-defined)
 add_compile_options(-ffile-prefix-map=${CMAKE_SOURCE_DIR}=.)
 
 add_compile_definitions(DEBUG SANITIZE_PTRS)
</code></pre>
<p>The system compiles, but fails to link after adding the new flag. The link errors
look something like:</p>
<pre><code>[1/948] Linking CXX shared library Libraries/LibC/libc.so
FAILED: Libraries/LibC/libc.so
../Libraries/LibC/stdlib.cpp:1062: undefined reference to `__stack_chk_fail_local'
</code></pre>
<p>It looks like we need to expose this symbol in the Serenity <code>LibC</code> implementation
so that the compile generated function epilogue code can call it. It turns out 
that there was some previous work here, and I just needed to extended it to get
it working again. This is what I came up with:</p>
<pre><code class="language-diff">diff --git a/Libraries/LibC/cxxabi.cpp b/Libraries/LibC/cxxabi.cpp
index cc920dec89..05978bfe9b 100644
--- a/Libraries/LibC/cxxabi.cpp
+++ b/Libraries/LibC/cxxabi.cpp
@@ -24,7 +24,6 @@
  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-#include &lt;AK/Types.h&gt;
 #include &lt;assert.h&gt;
 #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
@@ -87,11 +86,4 @@ void __cxa_finalize(void* dso_handle)
     ASSERT_NOT_REACHED();
 }
 
-extern u32 __stack_chk_guard;
-u32 __stack_chk_guard = (u32)0xc6c7c8c9;
-
-[[noreturn]] void __stack_chk_fail()
-{
-    ASSERT_NOT_REACHED();
-}
 } // extern &quot;C&quot;

diff --git a/Libraries/LibC/ssp.cpp b/Libraries/LibC/ssp.cpp
new file mode 100644
index 0000000000..c2715d6ba0
--- /dev/null
+++ b/Libraries/LibC/ssp.cpp
@@ -0,0 +1,55 @@
+#include &lt;AK/Types.h&gt;
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;sys/internals.h&gt;
+#include &lt;unistd.h&gt;
+
+extern &quot;C&quot; {
+
+extern u32 __stack_chk_guard;
+u32 __stack_chk_guard = (u32)0xc6c7c8c9;
+
+[[noreturn]] void __stack_chk_fail()
+{
+    dbgprintf(&quot;Error: Stack protector failure, stack smashing detected!\n&quot;);
+    if (__stdio_is_initialized)
+        fprintf(stderr, &quot;Error: Stack protector failure, stack smashing detected!\n&quot;);
+    abort();
+}
+
+[[noreturn]] void __stack_chk_fail_local()
+{
+    __stack_chk_fail();
+}
+
+} // extern &quot;C&quot;

diff --git a/Libraries/LibC/sys/internals.h b/Libraries/LibC/sys/internals.h
index 70443404e1..c23785a02e 100644
--- a/Libraries/LibC/sys/internals.h
+++ b/Libraries/LibC/sys/internals.h
@@ -43,5 +43,6 @@ 
 void __cxa_finalize(void* dso_handle);
 [[noreturn]] void __cxa_pure_virtual() __attribute__((weak));
 [[noreturn]] void __stack_chk_fail();
+[[noreturn]] void __stack_chk_fail_local();
 
 __END_DECLS
</code></pre>
<h2 id="getting-sidetracked-with-linking"><a class="header" href="#getting-sidetracked-with-linking">Getting Sidetracked with Linking</a></h2>
<p>Compiling again with the new <code>__stack_chk_fail_local</code> implementation available
in <code>LibC</code>, we surprisingly failed again with the same error. On closer inspection
it's actually slightly different, we successfully linked <code>LibC</code> but now we are
failing to link a different library <code>LibDiff</code> that depends on <code>LibC</code>:</p>
<pre><code>[334/1280] Linking CXX shared library Libraries/LibDiff/libdiff.so
FAILED: Libraries/LibDiff/libdiff.so
../Libraries/LibDiff/Hunks.cpp:113: undefined reference to `__stack_chk_fail_local'
../Libraries/LibC/stdlib.cpp:1062: undefined reference to `__stack_chk_fail_local'
</code></pre>
<p>I started debugging what was going on, so lets see what is ending up in the final
library. We can see that the <code>__stack_chk_fail_local</code> symbol is in the library but
notice the symbols flagged <code>l</code> instead of <code>g</code> like <code>__stack_chk_fail</code> is flagged:</p>
<pre><code class="language-bash">$ objdump -t Libraries/LibC/libc.so | rg __stack_chk_fail
0001ea58 l     F .text  00000015 __stack_chk_fail_local
0001ea08 g     F .text  00000050 __stack_chk_fail
</code></pre>
<p>The symbol table flags can be decoded using the <a href="https://www.man7.org/linux/man-pages/man1/objdump.1.html"><code>objdump(1)</code></a>
man page:</p>
<pre><code>The flag characters are divided into 7 groups as follows:

&quot;l&quot;
&quot;g&quot;
&quot;u&quot;
&quot;!&quot; The symbol is a local (l), global (g), unique global (u),
   neither global nor local (a space) or both global and
   local (!).  A symbol can be neither local or global for a
   variety of reasons, e.g., because it is used for
   debugging, but it is probably an indication of a bug if
   it is ever both local and global.  Unique global symbols
   are a GNU extension to the standard set of ELF symbol
   bindings.  For such a symbol the dynamic linker will make
   sure that in the entire process there is just one symbol
   with this name and type in use.
</code></pre>
<p>So somehow the <code>__stack_chk_fail_local</code> symbol is getting marked local (l) instead
of global (g) like most other symbols in the application. After researching around
online I ran across the <a href="https://www.openwall.com/lists/musl/2018/09/11/2">following thread</a>
which provides some useful insight into how the stack protector support is supposed
to be linked into applications when running on Linux:</p>
<pre><code class="language-http">Date: Tue, 11 Sep 2018 15:07:50 +0200
From: Szabolcs Nagy &lt;nsz@...t70.net&gt;
To: musl@...ts.openwall.com
Subject: Re: undefined reference to __stack_chk_fail_local (x86)

* Matias Fonzo &lt;selk@...gora.org&gt; [2018-09-11 09:27:45 -0300]:
&gt; Bootstrapping Dragora (distro) reflects an error trying to build the
&gt; kernel headers using musl 1.1.20:
&gt; 
&gt; Running build() ...
&gt;   UPD     include/generated/uapi/linux/version.h
&gt;   HOSTCC  scripts/basic/fixdep
&gt; /tmp/ccONBchp.o: In function `read_file':
&gt; fixdep.c:(.text+0x12a): undefined reference to `__stack_chk_fail_local'
&gt; /tmp/ccONBchp.o: In function `main':
&gt; fixdep.c:(.text.startup+0x6e2): undefined reference to
&gt; `__stack_chk_fail_local' /tools/lib32/gcc/i586-linux-musl/bin/ld:
&gt; scripts/basic/fixdep: hidden symbol `__stack_chk_fail_local' isn't
&gt; defined /tools/lib32/gcc/i586-linux-musl/bin/ld:
&gt; final link failed: Bad value collect2: error: ld returned 1 exit status
&gt; make[1]: *** [scripts/Makefile.host:90: scripts/basic/fixdep] Error 1
&gt; make: *** [Makefile:464: scripts_basic] Error 2 Return status = 2
&gt; 

this happens because on i386 and powerpc gcc emits _local_ calls
to __stack_chk_fail_local which means it has to be defined within
the same module that you are linking (not in libc.so).
(that symbol should either call the extern __stack_chk_fail in
libc.so or just crash)

this should have been done by libgcc.a having a definition for
this symbol (since the compiler is using it), but instead it got
added to glibc libc_nonshared.a which is added to the link command
by using a linker script in place of libc.so.

musl does not want to copy that hack, so the usual workaround is
to make gcc pass -lssp_nonshared to the linker when stack-protector
is in use and then have a libssp_nonshared.a with the appropriate
definition. (this is what alpine linux does)

you can also do this manually or disable ssp with -fno-stack-protector,
it may also work if a preincluded header declared it as weak
so undefined weak reference would just become 0 (and crash at runtime
which is the intended behaviour), but i havent tested that.
</code></pre>
<p>After reading this I modified the CMake changes I had made to include my new 
<code>spp.cpp</code> file into <strong>LibC</strong> to factor it out into it's own static library
that can be automatically inserted as a dependent library whenever LibC is linked:</p>
<pre><code class="language-diff">diff --git a/Libraries/LibC/CMakeLists.txt b/Libraries/LibC/CMakeLists.txt
index 3366957d5d..971880ca00 100644
--- a/Libraries/LibC/CMakeLists.txt
+++ b/Libraries/LibC/CMakeLists.txt
@@ -71,13 +71,21 @@ 
 )
 
+add_library(ssp STATIC ssp.cpp)
 set(SOURCES ${LIBC_SOURCES} ${AK_SOURCES} ${ELF_SOURCES})
 
 serenity_libc_static(LibCStatic c)
-target_link_libraries(LibCStatic crt0)
+target_link_libraries(LibCStatic crt0 ssp)
 add_dependencies(LibCStatic LibM)
 
 set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -static-libstdc++&quot;)
 serenity_libc(LibC c)
-target_link_libraries(LibC crt0)
+target_link_libraries(LibC crt0 ssp)
 add_dependencies(LibC LibM)
</code></pre>
<p>With these changes the system now compiles and links cleanly!</p>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p>Now that we have the system compiling, lets write test program to make sure we
can actually crash the program when a stack smash is detected. The program should
overwrite a buffer on the stack:</p>
<pre><code class="language-cpp">#include &lt;cstdio&gt;

static void smasher(char* string)
{
#pragma GCC diagnostic push
#pragma GCC diagnostic ignored &quot;-Warray-bounds&quot;
    for (int i = 0; i &lt; 256; i++) {
        string[i] = 'A';
    }
#pragma GCC diagnostic pop
}

static void stack_to_smash()
{
    char string[8] = {};
    smasher(string);
}

int main()
{
    puts(&quot;[+] Starting the stack smash...&quot;);
    stack_to_smash();
    puts(&quot;[+] Stack smash wasn't detected!&quot;);

    return 0;
}
</code></pre>
<p>If we compile this, and boot into serenity and run our program what happens? </p>
<pre><code>courage ~ $ ./user/Tests/LibC/stack-smash
[+] Starting the stack smash ...
[+] Stack smash wasn't detected!
</code></pre>
<p>Hrm... that's not good, what's going on? </p>
<p>After looking at the disassembly it's obvious, the <code>stack_to_smash()</code> call is being
completely in-lined and optimized out.</p>
<pre><code class="language-x86asm">$ objdump -M intel --disassemble=main Userland/Tests/LibC/stack-smash
Userland/Tests/LibC/stack-smash:     file format elf32-i386
00000510 &lt;main&gt;:
 510:   8d 4c 24 04             lea    ecx,[esp+0x4]
 514:   83 e4 f0                and    esp,0xfffffff0
 517:   ff 71 fc                push   DWORD PTR [ecx-0x4]
 51a:   55                      push   ebp
 51b:   89 e5                   mov    ebp,esp
 51d:   53                      push   ebx
 51e:   e8 82 00 00 00          call   5a5 &lt;__x86.get_pc_thunk.bx&gt;
 523:   81 c3 e5 13 00 00       add    ebx,0x13e5
 529:   51                      push   ecx
 52a:   83 ec 0c                sub    esp,0xc
 52d:   8d 83 a1 ee ff ff       lea    eax,[ebx-0x115f]
 533:   50                      push   eax
 534:   e8 97 ff ff ff          call   4d0 &lt;puts@plt&gt;
 539:   8d 83 c1 ee ff ff       lea    eax,[ebx-0x113f]
 53f:   89 04 24                mov    DWORD PTR [esp],eax
 542:   e8 89 ff ff ff          call   4d0 &lt;puts@plt&gt;
 547:   8d 65 f8                lea    esp,[ebp-0x8]
 54a:   31 c0                   xor    eax,eax
 54c:   59                      pop    ecx
 54d:   5b                      pop    ebx
 54e:   5d                      pop    ebp
 54f:   8d 61 fc                lea    esp,[ecx-0x4]
 552:   c3                      ret
</code></pre>
<p>We can add <code>__attribute__((noinline))</code> to our function definitions to instruct
the compiler to not inline calls to our test functions:</p>
<pre><code class="language-cpp">#include &lt;cstdio&gt;

// Note: Needs to be 'noline' so stack canary isn't optimized out.
static void __attribute__((noinline)) smasher(char* string)
{
#pragma GCC diagnostic push
#pragma GCC diagnostic ignored &quot;-Warray-bounds&quot;
    for (int i = 0; i &lt; 256; i++) {
        string[i] = 'A';
    }
#pragma GCC diagnostic pop
}

// Note: Needs to be 'noline' so stack canary isn't optimized out.
static void __attribute__((noinline)) stack_to_smash()
{
    char string[8] = {};
    smasher(string);
}

int main()
{
    puts(&quot;[+] Starting the stack smash...&quot;);
    stack_to_smash();
    puts(&quot;[+] Stack smash wasn't detected!&quot;);

    return 0;
}
</code></pre>
<p>After re-compiling we can see the compiler instrumentation in the binary now,
note the injected calls to <code>__stack_chk_fail_local</code> in the disassembly of <code>_ZL14stack_to_smashv</code>:</p>
<pre><code class="language-x86asm">$ objdump -M intel --disassemble=main Userland/Tests/LibC/stack-smash
Userland/Tests/LibC/stack-smash:     file format elf32-i386
00000690 &lt;main&gt;:
 690:   8d 4c 24 04             lea    ecx,[esp+0x4]
 694:   83 e4 f0                and    esp,0xfffffff0
 697:   ff 71 fc                push   DWORD PTR [ecx-0x4]
 69a:   55                      push   ebp
 69b:   89 e5                   mov    ebp,esp
 69d:   53                      push   ebx
 69e:   e8 87 00 00 00          call   72a &lt;__x86.get_pc_thunk.bx&gt;
 6a3:   81 c3 29 15 00 00       add    ebx,0x1529
 6a9:   51                      push   ecx
 6aa:   83 ec 0c                sub    esp,0xc
 6ad:   8d 83 1d ee ff ff       lea    eax,[ebx-0x11e3]
 6b3:   50                      push   eax
 6b4:   e8 67 ff ff ff          call   620 &lt;puts@plt&gt;
 6b9:   e8 1c 02 00 00          call   8da &lt;_ZL14stack_to_smashv&gt;
 6be:   8d 83 3d ee ff ff       lea    eax,[ebx-0x11c3]
 6c4:   89 04 24                mov    DWORD PTR [esp],eax
 6c7:   e8 54 ff ff ff          call   620 &lt;puts@plt&gt;
 6cc:   8d 65 f8                lea    esp,[ebp-0x8]
 6cf:   31 c0                   xor    eax,eax
 6d1:   59                      pop    ecx
 6d2:   5b                      pop    ebx
 6d3:   5d                      pop    ebp
 6d4:   8d 61 fc                lea    esp,[ecx-0x4]
 6d7:   c3                      ret

000008c6 &lt;_ZL7smasherPc&gt;:
 8c6:   55                      push   ebp
 8c7:   89 c2                   mov    edx,eax
 8c9:   b9 00 01 00 00          mov    ecx,0x100
 8ce:   b0 41                   mov    al,0x41
 8d0:   89 e5                   mov    ebp,esp
 8d2:   57                      push   edi
 8d3:   89 d7                   mov    edi,edx
 8d5:   f3 aa                   rep stos BYTE PTR es:[edi],al
 8d7:   5f                      pop    edi
 8d8:   5d                      pop    ebp
 8d9:   c3                      ret

000008da &lt;_ZL14stack_to_smashv&gt;:
 8da:   e8 41 00 00 00          call   920 &lt;__x86.get_pc_thunk.ax&gt;
 8df:   05 ed 12 00 00          add    eax,0x12ed
 8e4:   55                      push   ebp
 8e5:   89 e5                   mov    ebp,esp
 8e7:   53                      push   ebx
 8e8:   83 ec 14                sub    esp,0x14
 8eb:   8d 98 28 00 00 00       lea    ebx,[eax+0x28]
 8f1:   c7 45 ec 00 00 00 00    mov    DWORD PTR [ebp-0x14],0x0
 8f8:   c7 45 f0 00 00 00 00    mov    DWORD PTR [ebp-0x10],0x0
 8ff:   8b 03                   mov    eax,DWORD PTR [ebx]
 901:   89 45 f4                mov    DWORD PTR [ebp-0xc],eax
 904:   31 c0                   xor    eax,eax
 906:   8d 45 ec                lea    eax,[ebp-0x14]
 909:   e8 b8 ff ff ff          call   8c6 &lt;_ZL7smasherPc&gt;
 90e:   8b 45 f4                mov    eax,DWORD PTR [ebp-0xc]
 911:   2b 03                   sub    eax,DWORD PTR [ebx]
 913:   74 05                   je     91a &lt;_ZL14stack_to_smashv+0x40&gt;
 915:   e8 5a 00 00 00          call   974 &lt;__stack_chk_fail_local&gt;
 91a:   83 c4 14                add    esp,0x14
 91d:   5b                      pop    ebx
 91e:   5d                      pop    ebp
 91f:   c3                      ret
</code></pre>
<p>With these changes we can see the system catches the corruption as expected:</p>
<pre><code>courage ~ $ ./user/Tests/LibC/stack-smash
[+] Starting the stack smash ...
Error: Stack protector failure, stack smashing detected!
Shell: Job 1 (/usr/Tests/LibC/stack-smash) Aborted
</code></pre>
<h2 id="final-pr"><a class="header" href="#final-pr">Final PR</a></h2>
<p>The resulting pull request is here: 
<a href="https://github.com/SerenityOS/serenity/pull/4726">Build + LibC: Enable -fstack-protector-strong in user space</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="writing-codeql-queries-for-serenityos"><a class="header" href="#writing-codeql-queries-for-serenityos">Writing CodeQL Queries for SerenityOS</a></h1>
<p>I previously added CodeQL static analysis support to the SerenityOS build workflow.
<a href="https://github.com/SerenityOS/serenity/pull/4175">https://github.com/SerenityOS/serenity/pull/4175</a></p>
<p>Unfortunately you there doesn't seem to be a way to consume the CodeQL database that as part of that
build pipline on GitHub.
This seems like a bit of an oversight, and I have raised an issue here: <a href="https://github.com/github/codeql-action/issues/355">https://github.com/github/codeql-action/issues/355</a></p>
<p>To work around that we will need to create our own database so we can write some custom CodeQL queries.</p>
<p><strong>Here are the steps I put together:</strong></p>
<ol>
<li>
<p>Setup a clone of the VSCode Starter Workspace (<a href="https://codeql.github.com/docs/codeql-for-visual-studio-code/setting-up-codeql-in-visual-studio-code/#using-the-starter-workspace">docs</a>)</p>
<pre><code class="language-bash">$ git clone https://github.com/github/vscode-codeql-starter.git
$ cd vscode-codeql-starter
$ git submodule update --init --remote
</code></pre>
</li>
<li>
<p>Build a codeql database for serenity OS (<a href="https://codeql.github.com/docs/codeql-cli/creating-codeql-databases/">docs</a>):</p>
<pre><code class="language-bash">$ codeql database create -l cpp -s /home/bgianf/src/serenity -c &quot;make -j -C /home/bgianf/src/serenity/BuildMake&quot; ~/serenity-codeql
</code></pre>
</li>
<li>
<p>Install the VS Code CodeQL extension (<a href="https://marketplace.visualstudio.com/items?itemName=GitHub.vscode-codeql">docs</a>)</p>
</li>
<li>
<p>Configure the VS Code CodeQL extension to point to your new database (<code>~/serenityy-codeql</code>)</p>
</li>
<li>
<p>Open the <code>vscode-codeql-starter</code> workspace in VS Code.</p>
</li>
<li>
<p>Open the <code>cpp/example.ql</code> query and start writing queries and executing them against the database.</p>
<p>This simple example finds all classes in the <code>AK</code> standard library in SerenityOS:</p>
<pre><code class="language-python">import cpp

from Class c
where c.getQualifiedName().matches(&quot;AK::%&quot;)
select base.getQualifiedName()

</code></pre>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="12-29-2020-initial-setup-of-the-polarfire-soc-icicle-kit"><a class="header" href="#12-29-2020-initial-setup-of-the-polarfire-soc-icicle-kit">12-29-2020: Initial Setup of the PolarFire SOC Icicle Kit</a></h1>
<h2 id="introduction-4"><a class="header" href="#introduction-4">Introduction</a></h2>
<p>I picked up the PolarFire SOC Icicle Kit during the crowd  funding phase on <a href="https://www.crowdsupply.com/microchip/polarfire-soc-icicle-kit">Crowd Supply</a>
I've been playing around with the hardware off and on since I got it,</p>
<p><img src="polarfire/./icicle-kit.png" alt="image of the polarfire SOC board" /></p>
<h2 id="useful-links"><a class="header" href="#useful-links">Useful Links:</a></h2>
<p>MicroChip Docs:</p>
<ul>
<li>
<p><a href="https://www.microsemi.com/products/fpga-soc/polarfire-soc-icicle-quick-start-guide#overview">MicroChip: PolarFire SoC Icicle Kit Quick Start Guide</a></p>
</li>
<li>
<p><a href="https://github.com/polarfire-soc/polarfire-soc-documentation/blob/master/boards/mpfs-icicle-kit-es/icicle-kit-sw-developer-guide/icicle-kit-sw-developer-guide.md">GitHub: Icicle Kit Software Developer Guide</a></p>
</li>
<li>
<p><a href="https://github.com/polarfire-soc/polarfire-soc-documentation/blob/master/boards/mpfs-icicle-kit-es/updating-icicle-kit/updating-icicle-kit-design-and-linux.md">GitHub: Updating PolarFire SOC Icicle-Kit FPGA Design and Linux Image</a></p>
</li>
</ul>
<p>seL4 Port:</p>
<ul>
<li>
<p><a href="https://dornerworks.com/blog/sel4-on-polarfire-soc">seL4 on the PolarFire SOC</a></p>
</li>
<li>
<p><a href="https://dornerworks.com/microchip/polarfire-soc/sel4-test-instructions/">seL4 Test on the PolarFire SOC</a></p>
</li>
</ul>
<p>Forums:</p>
<ul>
<li><a href="https://exchange.riscv.org/c/polarfiresoc-icicle">RISC-V Exchange</a></li>
</ul>
<h2 id="script-for-terminal-attach"><a class="header" href="#script-for-terminal-attach">Script for terminal attach</a></h2>
<p>After attaching with <a href="https://en.wikipedia.org/wiki/Minicom">minicom</a> manually a few times,
I eventually found the script below, it comes from the <a href="https://dornerworks.com/microchip/polarfire-soc/sel4-test-instructions/">seL4 Test o the PolarFire SOC</a>
documentation. It works pretty well, and uses <a href="https://github.com/tio/tio">tio</a> (which I find
much more pleasant to work with) instead of <strong>minicom</strong>.</p>
<pre><code class="language-bash">#!/bin/bash
tmux new-session -d -s 'polarfire-serial-dashboard'
tmux split-window -v
tmux split-window -h
tmux select-pane -t 0
tmux split-window -h
tmux respawn-pane -t0 -k &quot;tio /dev/ttyUSB0&quot;
tmux respawn-pane -t1 -k &quot;tio /dev/ttyUSB1&quot;
tmux respawn-pane -t2 -k &quot;tio /dev/ttyUSB2&quot;
tmux respawn-pane -t3 -k &quot;tio /dev/ttyUSB3&quot;
tmux select-layout tiled
tmux set -g mouse on
tmux attach-session -t 'polarfire-serial-dashboard'
</code></pre>
<p>I've also setup the scripts as a gist here: <a href="https://gist.github.com/bgianfo/24a1623953a8d45cd72e918dd80510b3">PolarFire SOC Icicle Gists</a></p>
<h2 id="first-boot"><a class="header" href="#first-boot">First Boot</a></h2>
<p>After getting everything figured out I was able to boot, attached to all of
the UART serial consoles attached, and interact with the linux login.</p>
<p><img src="polarfire/./initial-boot.png" alt="first boot" /></p>
<p>I was a little excited at this point, so I announced my accomplishment to the world: </p>
<blockquote class="twitter-tweet" data-theme="dark"><p lang="en" dir="ltr">Finally got around to playing with my Polarfire SoC Icicle Kit. Screenshot is minicom attached to all 4 (!) UART serial debug consoles. riscv64 running linux for now, want to play with the seL4 port though. Maybe an attempt to port <a href="https://twitter.com/hashtag/serenityos?src=hash&amp;ref_src=twsrc%5Etfw">#serenityos</a>? 😃 <a href="https://twitter.com/hashtag/riscv?src=hash&amp;ref_src=twsrc%5Etfw">#riscv</a> <a href="https://twitter.com/hashtag/polarfire?src=hash&amp;ref_src=twsrc%5Etfw">#polarfire</a> <a href="https://t.co/q9EF98NhF3">pic.twitter.com/q9EF98NhF3</a></p>&mdash; Brian Gianforcaro (@bgianf) <a href="https://twitter.com/bgianf/status/1331864239842070528?ref_src=twsrc%5Etfw">November 26, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
