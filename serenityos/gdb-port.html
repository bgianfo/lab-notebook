<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>2022-02-20: Porting GDB - Brian&#x27;s Lab Notebook</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../background.html">Background</a></li><li class="chapter-item expanded "><div>Notes</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../notes/2020-12-29.html">2020-12-29: Lab Notebook Setup</a></li><li class="chapter-item "><a href="../notes/2020-12-29-gpg-signing.html">2020-12-29: Commit Signing</a></li></ol></li><li class="chapter-item expanded "><div>Serenity OS</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../serenityos/2020-12-30.html">2020-12-30: CodeQL Queries</a></li><li class="chapter-item "><a href="../serenityos/2021-01-01.html">2021-01-01: Stack Canaries</a></li><li class="chapter-item "><a href="../serenityos/2021-01-02.html">2021-01-02: KASAN Research</a></li><li class="chapter-item "><a href="../serenityos/2022-01-16.html">2022-01-06: GCC ftrivial-auto-var-init</a></li><li class="chapter-item expanded "><a href="../serenityos/gdb-port.html" class="active">2022-02-20: Porting GDB</a></li></ol></li><li class="chapter-item expanded "><div>PolarFire SOC Icicle</div><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../polarfire/2020-11-26.html">2020-11-26: Initial Setup</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Brian&#x27;s Lab Notebook</h1>

                    <div class="right-buttons">
                        <a href="http://github.com/bgianfo/lab-notebook" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/bgianfo/lab-notebook/edit/main/src/serenityos/gdb-port.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="porting-gdb-to-serenityos"><a class="header" href="#porting-gdb-to-serenityos">Porting GDB to SerenityOS</a></h1>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>This is a living document that describes my process of porting GDB to SerenityOS.
The following changes have made it into the tree to support this work: </p>
<ul>
<li><input disabled="" type="checkbox" checked=""/>
<a href="https://github.com/SerenityOS/serenity/commit/7828d4254e7707adcb9bf7190e5c3dc7a8a7d9de">LibC: Stub out tcsendbreak(..) and tcdrain(..)</a></li>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/SerenityOS/serenity/commit/fcdd2027419607bed6b24a9ee364d6ad4cd99a41">Kernel: Return the actual number of CPU cores that we have</a></li>
<li><input disabled="" type="checkbox" checked=""/>
<a href="https://github.com/SerenityOS/serenity/pull/11216">Kernel: Signals galore</a> </li>
<li><input disabled="" type="checkbox" checked=""/>
<a href="https://github.com/SerenityOS/serenity/commit/bd3bbd032949642ab113058e6372de40af7f0b2c">Ports: Add initial GDB 11.1 port</a></li>
<li><input disabled="" type="checkbox" checked=""/>
<a href="https://github.com/SerenityOS/serenity/commit/1210ee9ba9b9a20346cb90e9e1baa92ee1f240d0">LibC: Make regs.h work with compilers without concepts</a></li>
<li><input disabled="" type="checkbox" checked=""/>
<a href="https://github.com/SerenityOS/serenity/commit/6137b9f2725c7aee874ac9ef05c4bd23033f1a29">Ports/gdb: Fix compiler -fpermissive warnings from using latest GCC</a></li>
<li><input disabled="" type="checkbox" checked=""/>
<a href="https://github.com/SerenityOS/serenity/commit/e308536005020bb03fd34304fd81e17716e620a9">Ports/gdb: Add basic ptrace based native target for SerenityOS/i386</a></li>
<li><input disabled="" type="checkbox" checked=""/>
<a href="https://github.com/SerenityOS/serenity/commit/70f3fa2dd2d8923fbd683dda9048938629ac5044">Kernel: Set new process name in <code>do_exec</code> before waiting for the tracer</a></li>
<li><input disabled="" type="checkbox" checked=""/>
<a href="https://github.com/SerenityOS/serenity/commit/f01e1d0c17caca18b6d4723bf7579a20395cb6cc">Ports/gdb: Add descriptions to all gdb patches and remove dead code</a></li>
<li><input disabled="" type="checkbox"/>
<a href="https://github.com/SerenityOS/serenity/commit/e56262caedb0a1dc3010bfd8209682aa7fde3356">Ports/gdb: Implement wait and mourn_inferior overrides for our target</a></li>
<li><input disabled="" type="checkbox" checked=""/>
<a href="https://github.com/SerenityOS/serenity/commit/213df97b55f83889e405f84b294a1c754be4b184">Ports/gdb: Upgrade gdb to version 11.2</a></li>
</ul>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>While working on SerenityOS over the past few years, one of the things I‚Äôve missed
the most is a powerful debugger. For whatever reason <a href="https://awesomekling.github.io/about/">Andreas</a> and most of the
other developers working on the system don‚Äôt seem to be fans of using a debugger.
Now that I think about it, Andreas even has a video titled
<a href="https://www.youtube.com/watch?v=epcaK_bhWWA">‚ÄúWhy I don‚Äôt use a debugger‚Äù</a> on his YouTube channel. üòÅ</p>
<p><a href="https://twitter.com/ItamarShenhar">Itamar Shenhar</a> has been doing a bunch of work on Hack Studio,
and as part of that has implemented <code>ptrace(..)</code> and a basic debugger known as <code>sdb</code> (See <a href="https://github.com/SerenityOS/serenity/pull/1885">PR #1885</a>):</p>
<pre><code class="language-sh">courage:~ $ sdb /bin/ls
Program is stopped at: 0x0bfae99d (Loader.so:ELF::DynamicLinker::linker_main() +0x5ed)

(sdb) help
Options:
cont - Continue execution
si - step to the next instruction
sl - step to the next source line
line - show the position of the current instruction in the source code
regs - Print registers
dis [number of instructions] - Print disassembly
bp &lt;address/symbol/file:line&gt; - Insert a breakpoint
bt - show backtrace for current thread
x &lt;address&gt; - examine dword in memory

(sdb) dis 1
    0x0bfae99d &lt;+0&gt;:
</code></pre>
<p>The debugger integration with <code>Hack Studio</code> and the standalone <code>sdb</code> debugger are great first passes at some
basic debugging infrastructure. During my time at Microsoft, I have learned to love the debugger for root
causing complicated systems level bugs and even learning how a complex program works, there‚Äôs no better tool in my
opinion. I think I would be a lot more productive working on Serenity if I had a more powerful debugger,
like <code>gdb</code>.  That‚Äôs when I decided to try porting the <strong>GNU Project Debugger</strong> to SerenityOS!</p>
<h2 id="getting-things-compiling"><a class="header" href="#getting-things-compiling">Getting Things Compiling</a></h2>
<p>The initial work to get the debugger to compile went smoothly. The work started in </p>
<p><a href="https://github.com/SerenityOS/serenity/pull/11278">PR #11278 - LibC+Ports: Add initial GDB 11.1 port</a>.</p>
<h4 id="setting-up-the-port-script"><a class="header" href="#setting-up-the-port-script">Setting up the port script</a></h4>
<p>The first task at hand was to create a script to automate the building of the port.
Serenity has it‚Äôs own <a href="https://github.com/SerenityOS/serenity/blob/master/Ports/README.md">ports system</a> for describing how assets should be downloaded
and then subsequently unpackaged, and built. The initial version I arrive on looked
something like this:</p>
<pre><code class="language-sh">#!/usr/bin/env -S bash ../.port_include.sh
port=gdb
version=11.1
useconfigure=true
configopts=(&quot;--target=${SERENITY_ARCH}-pc-serenity&quot; &quot;--with-sysroot=/&quot; &quot;--with-build-sysroot=${SERENITY_INSTALL_ROOT}&quot; &quot;--with-newlib&quot; &quot;--enable-languages=c,c++&quot; &quot;--disable-lto&quot; &quot;--disable-nls&quot; &quot;--enable-shared&quot; &quot;--enable-default-pie&quot; &quot;--enable-host-shared&quot; &quot;--enable-threads=posix&quot;)
files=&quot;https://ftpmirror.gnu.org/gnu/gdb/gdb-${version}.tar.xz gdb-${version}.tar.xz cccfcc407b20d343fb320d4a9a2110776dd3165118ffd41f4b1b162340333f94&quot;
makeopts+=(&quot;all&quot;)
installopts=(&quot;DESTDIR=${SERENITY_INSTALL_ROOT}&quot;)
depends=(&quot;gmp&quot; &quot;binutils&quot;)
auth_type=&quot;sha256&quot;

# We only have a stub of getrusage(..)
export ac_cv_func_getrusage=no

# We don't support the madvise options that are used.
export ac_cv_func_madvise=no
</code></pre>
<p>We can see this does a few things:</p>
<ul>
<li>Specifies what version of the gdb source to download and a sha256 hash to validate that <code>.tar.xz</code> package with.</li>
<li>Specifies that the port expects us to run the <code>configure</code> script.</li>
<li>Specifies the configure options, which are mostly about how to target serenity‚Äôs headers and libs, and what options to enable or disable.</li>
<li>Expresses a dependency on the <code>gmp</code> and <code>binutils</code> ports.</li>
</ul>
<h4 id="missing-dependencies"><a class="header" href="#missing-dependencies">Missing Dependencies</a></h4>
<p>The next step was to modify the gdb <code>configure</code> scripts to enlighten them about the platform triplets (<code>i386-pc-serenity</code>, <code>x86_64-pc-serenity</code>), </p>
<pre><code class="language-diff">diff --git a/bfd/config.bfd b/bfd/config.bfd
index 30087e3..11dc114 100644
--- a/bfd/config.bfd
+++ b/bfd/config.bfd
@@ -634,6 +634,11 @@ case &quot;${targ}&quot; in
     targ_selvecs=
     targ64_selvecs=x86_64_elf64_vec
     ;;
+  i[3-7]86-*-serenity*)
+    targ_defvec=i386_elf32_vec
+    targ_selvecs=
+    targ64_selvecs=x86_64_elf64_vec
+    ;;
 #ifdef BFD64
   x86_64-*-cloudabi*)
     targ_defvec=x86_64_elf64_cloudabi_vec
@@ -694,6 +699,10 @@ case &quot;${targ}&quot; in
     targ_selvecs=i386_elf32_vec
     want64=true
     ;;
+  x86_64-*-serenity*)
+    targ_defvec=x86_64_elf64_vec
+    want64=true
+    ;;
 #endif
   i[3-7]86-*-lynxos*)
     targ_defvec=i386_elf32_vec
</code></pre>
<p>With the triplets in place I was able to actually build some code. I quickly
found some pieces we were missing. One of them was <code>sigtimedwait()</code>, I <a href="https://discord.com/channels/830522505605283862/830525093905170492/919194323969540146">mentioned
it in the project‚Äôs discord</a> and it just so happened that
<a href="https://github.com/IdanHo">Idan Horowitz</a> had recently worked on the signal handling subsystem in the Kernel offered to help me out.</p>
<pre><code>bgianf ‚Äî 12/11/2021
If anyone is interested in some kernel work,
I need sigtimedwait() for a port of GDB.
I'll get around to it if no one is interested...
but just thought I'd throw it out there in case someone is collecting yaks 

IdanHo ‚Äî 12/11/2021
I just touched signal handling a bunch, so I'll try looking into it
</code></pre>
<p>I continued to work in parallel, but the next morning I woke up to a nice little
gift, Idan had sent out <a href="https://github.com/SerenityOS/serenity/pull/11216">Kernel+LibC: Signals galore</a> which included
support for <code>sigtimedwait()</code>!</p>
<p>The next issues I encountered  were the <code>pthread_sigmask</code> and the pthread signal APIs
that gdb can use. SerenityOS didn‚Äôt implement these APIs at the time, but it was easy
enough to disable them to make progress as gdb appeared to have fallback mechanisms when
they were disabled. This ended up being a patch to the <code>configure</code> script:</p>
<pre><code class="language-diff">diff --git a/gdbsupport/configure b/gdbsupport/configure
index a9dd02c..3c5bcf5 100755
--- a/gdbsupport/configure
+++ b/gdbsupport/configure
@@ -8934,7 +8934,7 @@ $as_echo &quot;$gdb_cv_cxx_std_thread&quot; &gt;&amp;6; }

     # This check must be here, while LIBS includes any necessary
     # threading library.
-    for ac_func in pthread_sigmask pthread_setname_np
+    for ac_func in pthread_setname_np
 do :
   as_ac_var=`$as_echo &quot;ac_cv_func_$ac_func&quot; | $as_tr_sh`
 ac_fn_cxx_check_func &quot;$LINENO&quot; &quot;$ac_func&quot; &quot;$as_ac_var&quot;
diff --git a/libiberty/configure b/libiberty/configure
index fffb91d..defc239 100755
--- a/libiberty/configure
+++ b/libiberty/configure
@@ -6478,7 +6478,9 @@ case &quot;${host}&quot; in
     $as_echo &quot;#define HAVE_SYS_ERRLIST 1&quot; &gt;&gt;confdefs.h

     $as_echo &quot;#define HAVE_SYS_NERR 1&quot; &gt;&gt;confdefs.h
-
+    ;;
+  *-*-serenity*)
+    $as_echo &quot;#define HAVE_PSIGNAL 1&quot; &gt;&gt;confdefs.h
     ;;
 esac
</code></pre>
<p>The last thing holding us back from successfully compiling + linking gdb was that SerenityOS didn‚Äôt implement <code>tcsendbreak(..)</code>
or <code>tcdrain(..)</code>. I stubbed these calls to return error and set <code>errno = ENOTSUP</code>.
After putting all of these changes together, I had a basic gdb build successfully compiling!</p>
<h4 id="gdb-enlightenment"><a class="header" href="#gdb-enlightenment">GDB Enlightenment</a></h4>
<p>Now that we had gdb building, we could move on to the actual meat of the problem. How do we enlighten the debugger
to know about SerenityOS as a platform?</p>
<p>Looking at the gdb source, there is a pattern of having a few different files:</p>
<ul>
<li><code>&lt;os&gt;-nat.c</code></li>
<li><code>&lt;architecture&gt;-&lt;os&gt;-nat.c</code></li>
<li><code>&lt;os&gt;-tdep.c</code></li>
<li><code>&lt;architecture&gt;-&lt;os&gt;-tdep.c</code></li>
</ul>
<p>Here are the files for FreeBSD for example:</p>
<pre><code>~/src/serenity/Ports/gdb/gdb-11.2/gdb$ ls *fbsd*.c
aarch64-fbsd-nat.c   arm-fbsd-tdep.c   mips-fbsd-nat.c	 riscv-fbsd-tdep.c
aarch64-fbsd-tdep.c  fbsd-nat.c        mips-fbsd-tdep.c  sparc64-fbsd-nat.c
amd64-fbsd-nat.c     fbsd-tdep.c       ppc-fbsd-nat.c	 sparc64-fbsd-tdep.c
amd64-fbsd-tdep.c    i386-fbsd-nat.c   ppc-fbsd-tdep.c
arm-fbsd-nat.c	     i386-fbsd-tdep.c  riscv-fbsd-nat.c
</code></pre>
<p>After reading some code the pattern seems to be that gdb places ‚Äútarget-dependent code‚Äù
in the <code>-tdep.c</code> files, and ‚Äúnative-dependent code‚Äù in the <code>-nat.c</code> files.
I also saw that there appears to be a generic <code>ptrace()</code> based target that a few other
operating systems derive from. In the source it‚Äôs called <code>inf_ptrace_target</code>.
As I mentioned at the beginning of this post, serenity has basic ptrace support, so reusing
the ptrace inferior target sounded like a good initial game plane.</p>
<p>After hacking around for a while on and off I eventually had a basic target which should
theoretically allow us to use gdb to ptrace a serenity program. The broad strokes included:</p>
<ul>
<li>Deciding to target Serenity on i386/i686 to start, amd64 will follow later.</li>
<li>Hooking up our new files to build when targeting SerenityOS.</li>
<li>Mapping Serenity‚Äôs layout of i386 CPU registers to gdb‚Äôs.</li>
<li>Adding a new <code>i386_serenity_nat_target</code> devied from <code>serenity_nat_target</code>.</li>
<li>Adding a new OS ABI in gdb for SerenityOS</li>
<li>Adding initialization routines to our new target and OS ABI with gdb at runtime. </li>
</ul>
<p>The initial version looked something like this, it was later cleaned up as <a href="https://github.com/SerenityOS/serenity/commit/e308536005020bb03fd34304fd81e17716e620a9">Ports/gdb: Add basic ptrace based native target for SerenityOS/i386</a>:</p>
<pre><code class="language-diff">diff --git a/gdb/configure.nat b/gdb/configure.nat
index e34cccf..38b687e 100644
--- a/gdb/configure.nat
+++ b/gdb/configure.nat
@@ -86,6 +86,9 @@ case ${gdb_host} in
     darwin)
 	NATDEPFILES='fork-child.o nat/fork-inferior.o darwin-nat.o \
 	    darwin-nat-info.o'
+    ;;
+    serenity)
+	NATDEPFILES='fork-child.o nat/fork-inferior.o inf-ptrace.o'
 	;;
     sol2)
 	NATDEPFILES='fork-child.o nat/fork-inferior.o \
@@ -477,6 +480,14 @@ case ${gdb_host} in
 		;;
 	esac
 	;;
+    serenity)
+	case ${gdb_host_cpu} in
+	    i386)
+		# Host: SerenityOS/x86_64 ELF
+		NATDEPFILES=&quot;${NATDEPFILES} amd64-nat.o serenity-nat.o i386-serenity-nat.o&quot;
+		;;
+	esac
+	;;
     sol2)
 	case ${gdb_host_cpu} in
 	    i386)
diff --git a/gdb/configure.tgt b/gdb/configure.tgt
index 97a5a57..886542f 100644
--- a/gdb/configure.tgt
+++ b/gdb/configure.tgt
@@ -291,6 +291,10 @@ i[34567]86-*-nto*)
 	gdb_target_obs=&quot;solib-svr4.o \
 			i386-nto-tdep.o nto-tdep.o&quot;
 	;;
+i[34567]86-*-serenity*)
+	# Target: SerenityOS/i386
+	gdb_target_obs=&quot;i386-serenity-tdep.o serenity-tdep.o&quot;
+	;;
 i[34567]86-*-solaris2* | x86_64-*-solaris2*)
 	# Target: Solaris x86_64
 	gdb_target_obs=&quot;${i386_tobjs} ${amd64_tobjs} \

diff --git a/gdb/i386-serenity-nat.c b/gdb/i386-serenity-nat.c
new file mode 100644
index 0000000..034252a
--- /dev/null
+++ b/gdb/i386-serenity-nat.c
@@ -0,0 +1,101 @@
+/* Native-dependent code for SerenityOS/i386. */
+
+#include &quot;defs.h&quot;
+#include &quot;gdbcore.h&quot;
+#include &quot;regcache.h&quot;
+#include &quot;regset.h&quot;
+#include &quot;target.h&quot;
+
+#include &lt;sys/arch/i386/regs.h&gt;
+#include &lt;sys/ptrace.h&gt;
+
+#include &quot;i386-tdep.h&quot;
+#include &quot;serenity-nat.h&quot;
+
+/* Register maps.  */
+
+static const struct regcache_map_entry i386_serenity_gregmap[] =
+{
+    { 1, I386_EAX_REGNUM, 0 }, 
+    { 1, I386_ECX_REGNUM, 0 }, 
+    { 1, I386_EDX_REGNUM, 0 }, 
+    { 1, I386_EBX_REGNUM, 0 }, 
+    { 1, I386_ESP_REGNUM, 0 }, 
+    { 1, I386_EBP_REGNUM, 0 }, 
+    { 1, I386_ESI_REGNUM, 0 }, 
+    { 1, I386_EDI_REGNUM, 0 }, 
+    { 1, I386_EIP_REGNUM, 0 }, 
+    { 1, I386_EFLAGS_REGNUM, 0 }, 
+    { 1, I386_CS_REGNUM, 0 }, 
+    { 1, I386_SS_REGNUM, 0 }, 
+    { 1, I386_DS_REGNUM, 0 }, 
+    { 1, I386_ES_REGNUM, 0 }, 
+    { 1, I386_FS_REGNUM, 0 }, 
+    { 1, I386_GS_REGNUM, 0 }, 
+    { 0 },
+};
+
+const struct regset i386_serenity_gregset =
+{
+    i386_serenity_gregmap, regcache_supply_regset, regcache_collect_regset
+};
+
+class i386_serenity_nat_target final : public serenity_nat_target
+{
+  void fetch_registers (struct regcache* cache, int regnum) override
+  {
+    if (regnum == -1) {
+      pid_t pid = get_ptrace_pid (cache-&gt;ptid ());
+      PtraceRegisters regs;
+
+      if (ptrace (PT_GETREGS, pid, &amp;regs, 0) == -1)
+        perror_with_name (_(&quot;Couldn't get registers&quot;));
+
+      cache-&gt;supply_regset (&amp;i386_serenity_gregset, regnum, &amp;regs,
+              sizeof (regs));
+    }
+  };
+
+  void store_registers (struct regcache* cache, int regnum) override
+  {
+    if (regnum == -1) {
+      pid_t pid = get_ptrace_pid (cache-&gt;ptid ());
+      PtraceRegisters regs {};
+
+      if (ptrace (PT_GETREGS, pid, (PTRACE_TYPE_ARG3) &amp;regs, 0) == -1)
+        perror_with_name (_(&quot;Couldn't get registers&quot;));
+
+      cache-&gt;collect_regset (&amp;i386_serenity_gregset, regnum, &amp;regs,
+			       sizeof (regs));
+
+      if (ptrace (PT_SETREGS, pid, (PTRACE_TYPE_ARG3) &amp;regs, 0) == -1)
+        perror_with_name (_(&quot;Couldn't write registers&quot;));
+    }
+  };
+};
+
+static i386_serenity_nat_target the_i386_serenity_nat_target;
+
+void _initialize_i386_serenity_nat ();
+void
+_initialize_i386_serenity_nat ()
+{
+  add_inf_child_target (&amp;the_i386_serenity_nat_target);
+}

diff --git a/gdb/i386-serenity-tdep.c b/gdb/i386-serenity-tdep.c
new file mode 100644
index 0000000..d384061
--- /dev/null
+++ b/gdb/i386-serenity-tdep.c
@@ -0,0 +1,27 @@
+/* Target-dependent code for SerenityOS/i386. */
+
+#include &quot;defs.h&quot;
+#include &quot;arch-utils.h&quot;
+#include &quot;gdbcore.h&quot;
+#include &quot;osabi.h&quot;
+#include &quot;regcache.h&quot;
+
+/* Implement the 'init_osabi' method of struct gdb_osabi_handler.  */
+static void
+i386_serenity_init_abi (struct gdbarch_info info, struct gdbarch *gdbarch)
+{
+  /* Generic SerenityOS support.  */
+  serenity_init_abi (info, gdbarch);
+}
+
+void _initialize_i386_serenity_tdep ();
+void
+_initialize_i386_serenity_tdep ()
+{
+  gdbarch_register_osabi (bfd_arch_i386, 0, GDB_OSABI_SERENITYOS,
+			  i386_serenity_init_abi);
+}

diff --git a/gdb/osabi.c b/gdb/osabi.c
index aabf895..28789e8 100644
--- a/gdb/osabi.c
+++ b/gdb/osabi.c
@@ -82,6 +82,7 @@ static const struct osabi_names gdb_osabi_names[] =
   { &quot;Newlib&quot;, NULL },
   { &quot;SDE&quot;, NULL },
   { &quot;PikeOS&quot;, NULL },
+  { &quot;SerenityOS&quot;, NULL },

   { &quot;&lt;invalid&gt;&quot;, NULL }
 };

diff --git a/gdb/osabi.h b/gdb/osabi.h
index 1ecbed4..73c5549 100644
--- a/gdb/osabi.h
+++ b/gdb/osabi.h
@@ -46,6 +46,7 @@ enum gdb_osabi
   GDB_OSABI_NEWLIB,
   GDB_OSABI_SDE,
   GDB_OSABI_PIKEOS,
+  GDB_OSABI_SERENITYOS,

   GDB_OSABI_INVALID		/* keep this last */
 };

diff --git a/gdb/serenity-nat.c b/gdb/serenity-nat.c
new file mode 100644
index 0000000..ff740d4
--- /dev/null
+++ b/gdb/serenity-nat.c
@@ -0,0 +1,13 @@
+/* Native-dependent code for SerenityOS  */
+
+#include &quot;defs.h&quot;
+#include &quot;gdbthread.h&quot;
+#include &quot;inferior.h&quot;
+#include &quot;target.h&quot;
+
+#include &lt;sys/types.h&gt;
+#include &lt;sys/ptrace.h&gt;
+#include &quot;gdbsupport/gdb_wait.h&quot;
+
+#include &quot;inf-child.h&quot;
+#include &quot;serenity-nat.h&quot;

diff --git a/gdb/serenity-nat.h b/gdb/serenity-nat.h
new file mode 100644
index 0000000..ac3cfaa
--- /dev/null
+++ b/gdb/serenity-nat.h
@@ -0,0 +1,34 @@
+/* Native-dependent code for SerenityOS.  */
+
+#ifndef SERENITYOS_NAT_H
+#define SERENITYOS_NAT_H
+
+#include &quot;inf-ptrace.h&quot;
+
+/* A prototype generic Serenity target.
+   A concrete instance should override it with local methods. 
+*/
+
+class serenity_nat_target : public inf_ptrace_target
+{
+};
+
+#endif /* serenity-nat.h */
</code></pre>
<p>Once I tried to get this compiling I ran into a funny issue with SerenityOS‚Äôs LibC and <code>ptrace()</code> implementation.
The implementation exposes registers via a struct <code>PtraceRegisters</code>, which assumed that everything that would ever use
it would be using the SerenityOS AK<sup class="footnote-reference"><a href="#ak-footnote">1</a></sup> library, so it pulled in private types. As you can imagine this caused
a few problems as GDB has no idea about these types, and we were leaking implementation details from our LibC to a random port.
This was easy enough to fix, we just needed to avoid using Serenity specific types and defining C++ functions via this C ABI.
The diff is a bit boring, so I won‚Äôt include the whole thing here üòÅ. 
After this change to LibC we were back in business and our new serenity target was compiling.</p>
<p>Commit Link: <a href="https://github.com/SerenityOS/serenity/commit/1210ee9ba9b9a20346cb90e9e1baa92ee1f240d0">LibC: Make regs.h work with compilers without concepts</a></p>
<h2 id="testing--debugging"><a class="header" href="#testing--debugging">Testing &amp; Debugging</a></h2>
<p>At this stage we had gdb compiling, and it had the basic knowledge about the serenity platform.
So lets try to start it up and see what happens!</p>
<p>The very first time I tried to start <code>gdb</code> on the system, it immediately appeared to hang.
Since I did not have a working debugger, I just used the Serenity Profiler to see where the code
was spinning. I was able to narrow down the problem down to gdb not gracefully handling the <code>tcdrain(..)</code> or <code>tcsendbreak(..)</code> failure.
These were the same functions I stubbed out eariler in Serenity‚Äôs LibC, so they always return failure.
Returning an error here was causing <code>gdb</code> to just spin trying to call it over and over again.
Fortunately, we did not have to worry about supporting real terminals, only pseudo terminals, so just changing
the implementation to do nothing but claim success was sufficient for our purposes.
Commit Link: <a href="https://github.com/SerenityOS/serenity/pull/11278/commits/99061e7af4f8f698c40581134633163d53f25a09">LibC: Stub out tcsendbreak(..) and tcdrain()</a>:</p>
<p>This was another checkpoint for me</p>
<p>Now that we had some basic code setup and a basic understanding of gdb‚Äôs code
is put together it was time to start trying to see what was left to get something
really working.
Much to my surprise, we could see real signs of life after including our basic serenity support.</p>
<p><img style="display: block;
           margin-left: auto;
           margin-right: auto;
           width: 80%;"
src="https://user-images.githubusercontent.com/1212/147570590-b841b53a-4971-4154-92dc-d09c530d86e5.png"/></p>
<p>As you can see, the program doesn‚Äôt seem to actually run, it just hangs after launch.</p>
<h2 id="bonus-bug-kernel-process-name-after-pt_trace_me"><a class="header" href="#bonus-bug-kernel-process-name-after-pt_trace_me">Bonus Bug: Kernel Process Name after <code>PT_TRACE_ME</code></a></h2>
<p>After the initial port was compiling, I started to debug what in our implementation was
causing gdb to hang. If you looked at the processes under <code>System Monitor</code> you can see that we have
two processes named <code>gdb</code>, one sitting <code>Stopped</code>, and one sitting <code>Selecting</code> which is serenity‚Äôs way
of indicating a process is waiting for something.</p>
<p><img style="display: block; 
           margin-left: auto;
           margin-right: auto;
           width: 80%;"
src="gdb-incorrect-name.png"/></p>
<p>This doesn‚Äôt make any sense, why is gdb launching two processes, and why is it hanging waiting for itself?
One thing I was wondering is why was the <code>ptrace(..)</code> call failing with not permitted? I quickly hacked up some logging to the ptrace
implementation in the Kernel to let me see what was happening.</p>
<pre><code class="language-diff">diff --git a/Kernel/Syscalls/ptrace.cpp b/Kernel/Syscalls/ptrace.cpp
index 26d5d92e71..016007f97f 100644
--- a/Kernel/Syscalls/ptrace.cpp
+++ b/Kernel/Syscalls/ptrace.cpp
@@ -20,6 +20,7 @@ static ErrorOr&lt;FlatPtr&gt; handle_ptrace(const Kernel::Syscall::SC_ptrace_params&amp; p
 {
     SpinlockLocker scheduler_lock(g_scheduler_lock);
     if (params.request == PT_TRACE_ME) {
+        dbgln(&quot;PT_TRACE_ME - caller({}) &quot;, caller.pid());
         if (Process::current().tracer())
             return EBUSY;

@@ -49,6 +50,7 @@ static ErrorOr&lt;FlatPtr&gt; handle_ptrace(const Kernel::Syscall::SC_ptrace_params&amp; p

     auto&amp; peer_process = peer-&gt;process();
     if (params.request == PT_ATTACH) {
+        dbgln(&quot;PT_ATTACH - peer({}) caller({}) &quot;, peer_process.pid(), caller.pid());
         if (peer_process.tracer()) {
             return EBUSY;
         }
@@ -62,8 +64,10 @@ static ErrorOr&lt;FlatPtr&gt; handle_ptrace(const Kernel::Syscall::SC_ptrace_params&amp; p

     auto* tracer = peer_process.tracer();

-    if (!tracer)
+    if (!tracer) {
+        dbgln(&quot;ptrace - peer({}) has no tracer!&quot;, peer_process.pid());
         return EPERM;
+    }

     if (tracer-&gt;tracer_pid() != caller.pid())
         return EBUSY;
@@ -75,20 +79,24 @@ static ErrorOr&lt;FlatPtr&gt; handle_ptrace(const Kernel::Syscall::SC_ptrace_params&amp; p

     switch (params.request) {
     case PT_CONTINUE:
+        dbgln(&quot;PT_CONTINUE - peer({}) caller({}) &quot;, peer_process.pid(), caller.pid());
         peer-&gt;send_signal(SIGCONT, &amp;caller);
         break;

     case PT_DETACH:
+        dbgln(&quot;PT_DETACH - peer({}) caller({}) &quot;, peer_process.pid(), caller.pid());
         peer_process.stop_tracing();
         peer-&gt;send_signal(SIGCONT, &amp;caller);
         break;
</code></pre>
<p>Re-running <code>gdb /bin/ls</code> with the logging active in the kernel we now see the
following output:</p>
<pre><code>249.269 [#0 gdb(51:51)]: PT_TRACE_ME - caller(51)
249.273 [#0 gdb(49:49)]: PT_ATTACH - peer(51) caller(49)
249.273 [#0 gdb(49:49)]: PT_CONTINUE - peer(51) caller(49)
249.278 [#0 gdb(51:51)]: signal: SIGCONT resuming gdb(51:51)
</code></pre>
<p>The logging output gives us a clue, we appear to be properly forking and calling
ptrace correctly, however the name of the process appears to be incorrect in the
kernel? </p>
<p>After some digging around in the code, the issue turned out to be the location
where we were updating the process name in <code>execve(..)</code> had a very minor bug
which caused the process name to be incorrect. The fix was trivial, it can be
found here: <a href="https://github.com/SerenityOS/serenity/pull/12464">Kernel: Set new process name in do_exec before waiting for the tracer</a>.</p>
<p>The commit message itself provides a nice description of the interaction between
<code>fork()</code>, <code>ptrace()</code> and <code>execve(..)</code> that are involved here: </p>
<pre><code class="language-diff">From: Brian Gianforcaro &lt;bgianf@serenityos.org&gt;
Date: Sat, 12 Feb 2022 08:17:42 -0800
Subject: [PATCH] Kernel: Set new process name in `do_exec` before waiting for
 the tracer

While investigating why gdb is failing when it calls `PT_CONTINUE`
against Serenity I noticed that the names of the programs in the
System Monitor didn't make sense. They were seemingly stale.

After inspecting the kernel code, it became apparent that the sequence
occurs as follows:

    1. Debugger calls `fork()`
    2. The forked child calls `PT_TRACE_ME`
    3. The `PT_TRACE_ME` instructs the forked process to block in the
       kernel waiting for a signal from the tracer on the next call
       to `execve(..)`.
    4. Debugger waits for forked child to spawn and stop, and then it
       calls `PT_ATTACH` followed by `PT_CONTINUE` on the child.
    5. Currently the `PT_CONTINUE` fails because of some other yet to
       be found bug.
    6. The process name is set immediately AFTER we are woken up by
       the `PT_CONTINUE` which never happens in the case I'm debugging.

This chain of events leaves the process suspended, with the name  of
the original (forked) process instead of the name we inherit from
the `execve(..)` call.

To avoid such confusion in the future, we set the new name before we
block waiting for the tracer.
---
 Kernel/Syscalls/execve.cpp | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/Kernel/Syscalls/execve.cpp b/Kernel/Syscalls/execve.cpp
index 93d2e16dc3f42..8c27916837423 100644
--- a/Kernel/Syscalls/execve.cpp
+++ b/Kernel/Syscalls/execve.cpp
@@ -564,6 +564,9 @@ ErrorOr&lt;void&gt; Process::do_exec(NonnullRefPtr&lt;OpenFileDescription&gt; main_program_d
     //       and we don't want to deal with faults after this point.
     auto new_userspace_sp = TRY(make_userspace_context_for_main_thread(new_main_thread-&gt;regs(), *load_result.stack_region.unsafe_ptr(), m_arguments, m_environment, move(auxv)));

+    m_name = move(new_process_name);
+    new_main_thread-&gt;set_name(move(new_main_thread_name));
+
     if (wait_for_tracer_at_next_execve()) {
         // Make sure we release the ptrace lock here or the tracer will block forever.
         ptrace_locker.unlock();
@@ -583,9 +586,6 @@ ErrorOr&lt;void&gt; Process::do_exec(NonnullRefPtr&lt;OpenFileDescription&gt; main_program_d

     // NOTE: Be careful to not trigger any page faults below!

-    m_name = move(new_process_name);
-    new_main_thread-&gt;set_name(move(new_main_thread_name));
-
     {
         ProtectedDataMutationScope scope { *this };
         m_protected_values.promises = m_protected_values.execpromises.load();
</code></pre>
<p>After this fix, we can see that PID 40 calls <code>PT_TRACE_ME</code>, which suspended
itself in the kernel when it called <code>execve(..)</code>. The process name is correct
when processing the signal before, we have resumed the process.</p>
<pre><code>11.459 [#0 gdb(40:40)]: PT_TRACE_ME - caller(40)
11.463 [#0 gdb(38:38)]: PT_ATTACH - peer(40) caller(38)
11.463 [#0 gdb(38:38)]: PT_CONTINUE - peer(40) caller(38)
11.463 [#0 ls(40:40)]: signal: SIGCONT resuming ls(40:40)
</code></pre>
<!-- References -->
<div class="footnote-definition" id="ak-footnote"><sup class="footnote-definition-label">1</sup>
<p><a href="https://github.com/SerenityOS/serenity/blob/master/AK">AK</a> is short for Agnostic Kit, the common C++ library to be used in Kernel or UserMode in the SerenityOS code base.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../serenityos/2022-01-16.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../polarfire/2020-11-26.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../serenityos/2022-01-16.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../polarfire/2020-11-26.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
