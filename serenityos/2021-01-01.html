<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>2021-01-01: Stack Canaries - Brian&#x27;s Lab Notebook</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../background.html"><strong aria-hidden="true">1.</strong> Background</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Notes</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../notes/2020-12-29.html"><strong aria-hidden="true">2.1.</strong> 2020-12-29: Lab Notebook Setup</a></li><li class="chapter-item expanded "><a href="../notes/2020-12-29-gpg-signing.html"><strong aria-hidden="true">2.2.</strong> 2020-12-29: Commit Signing</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> SerenityOS</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../serenityos/2022-01-16.html"><strong aria-hidden="true">3.1.</strong> 2022-01-06: ftrivial-auto-var-init</a></li><li class="chapter-item expanded "><a href="../serenityos/2021-01-02.html"><strong aria-hidden="true">3.2.</strong> 2021-01-02: KASAN Research</a></li><li class="chapter-item expanded "><a href="../serenityos/2021-01-01.html" class="active"><strong aria-hidden="true">3.3.</strong> 2021-01-01: Stack Canaries</a></li><li class="chapter-item expanded "><a href="../serenityos/2020-12-30.html"><strong aria-hidden="true">3.4.</strong> 2020-12-30: CodeQL Queries</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> PolarFire SOC Icicle</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../polarfire/2020-11-26.html"><strong aria-hidden="true">4.1.</strong> 2020-11-26: Initial Setup</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Brian&#x27;s Lab Notebook</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="http://github.com/bgianfo/lab-notebook" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="enabling-stack-canaries-for-serenityos"><a class="header" href="#enabling-stack-canaries-for-serenityos">Enabling stack canaries for SerenityOS</a></h1>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>I've been looking into beefing up static and dynamic analysis available in
<a href="http://www.serenityos.org">SerenityOS</a>. One of the most basic things that
wasn't enabled yet was GCC's <code>-fstack-protector</code> feature, which automatically
inserts a <a href="https://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries">stack canary</a>
in the epilog of all functions.</p>
<p><a href="https://wiki.osdev.org/Stack_Smashing_Protector">osdev-wiki: Stack Smashing Protector</a></p>
<h2 id="which-variant-to-use"><a class="header" href="#which-variant-to-use">Which variant to use?</a></h2>
<p>There are three different variants of <code>-fstack-protector</code>, each with different
pros and cons. <a href="https://twitter.com/kees_cook">Kees Cook</a> has a nice writeup on
the specifics of <code>-fstack-protector-strong</code> and it's design on his <a href="https://outflux.net/blog/archives/2014/01/27/fstack-protector-strong/">blog</a>.</p>
<p>The <a href="https://www.keil.com/support/man/docs/armclang_ref/armclang_ref_cjh1548250046139.htm">ARM Clang Compiler Reference Guide</a>
has a nice overview of the different variants of <code>-fstack-protector</code> and their impact.</p>
<pre><code>-fno-stack-protector disables stack protection.

-fstack-protector enables stack protection for vulnerable functions that contain:

* A character array larger than 8 bytes.
* An 8-bit integer array larger than 8 bytes.
* A call to alloca() with either a variable size or a constant size bigger
  than 8 bytes.

-fstack-protector-all adds stack protection to all functions regardless of
 their vulnerability

-fstack-protector-strong enables stack protection for vulnerable functions
 that contain:

* An array of any size and type.
* A call to alloca().
* A local variable that has its address taken
</code></pre>
<p>It appears to me that <code>-fstack-protector-strong</code> would be a good compromise for
use in Serenity OS.</p>
<h2 id="bootstrapping-the-implementation"><a class="header" href="#bootstrapping-the-implementation">Bootstrapping the Implementation</a></h2>
<p>The actual change to the build system is (of course) very simple:</p>
<pre><code class="language-diff">diff --git a/CMakeLists.txt b/CMakeLists.txt
index 7597e97fab..df039d3f82 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -125,9 +125,7 @@ if (CMAKE_SYSTEM_NAME MATCHES Darwin)
     set(CMAKE_SKIP_RPATH TRUE)
 endif()
 
-#FIXME: -fstack-protector
-
-add_compile_options(-Os -g1 -fno-exceptions -Wno-address-of-packed-member -Wundef -Wcast-qual -Wwrite-strings -Wimplicit-fallthrough -Wno-nonnull-compare -Wno-deprecated-copy -Wno-expansion-to-defined)
+add_compile_options(-Os -g1 -fno-exceptions -fstack-protector-strong -Wno-address-of-packed-member -Wundef -Wcast-qual -Wwrite-strings -Wimplicit-fallthrough -Wno-nonnull-compare -Wno-deprecated-copy -Wno-expansion-to-defined)
 add_compile_options(-ffile-prefix-map=${CMAKE_SOURCE_DIR}=.)
 
 add_compile_definitions(DEBUG SANITIZE_PTRS)
</code></pre>
<p>The system compiles, but fails to link after adding the new flag. The link errors
look something like:</p>
<pre><code>[1/948] Linking CXX shared library Libraries/LibC/libc.so
FAILED: Libraries/LibC/libc.so
../Libraries/LibC/stdlib.cpp:1062: undefined reference to `__stack_chk_fail_local'
</code></pre>
<p>It looks like we need to expose this symbol in the Serenity <code>LibC</code> implementation
so that the compile generated function epilogue code can call it. It turns out 
that there was some previous work here, and I just needed to extended it to get
it working again. This is what I came up with:</p>
<pre><code class="language-diff">diff --git a/Libraries/LibC/cxxabi.cpp b/Libraries/LibC/cxxabi.cpp
index cc920dec89..05978bfe9b 100644
--- a/Libraries/LibC/cxxabi.cpp
+++ b/Libraries/LibC/cxxabi.cpp
@@ -24,7 +24,6 @@
  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  */
 
-#include &lt;AK/Types.h&gt;
 #include &lt;assert.h&gt;
 #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
@@ -87,11 +86,4 @@ void __cxa_finalize(void* dso_handle)
     ASSERT_NOT_REACHED();
 }
 
-extern u32 __stack_chk_guard;
-u32 __stack_chk_guard = (u32)0xc6c7c8c9;
-
-[[noreturn]] void __stack_chk_fail()
-{
-    ASSERT_NOT_REACHED();
-}
 } // extern &quot;C&quot;

diff --git a/Libraries/LibC/ssp.cpp b/Libraries/LibC/ssp.cpp
new file mode 100644
index 0000000000..c2715d6ba0
--- /dev/null
+++ b/Libraries/LibC/ssp.cpp
@@ -0,0 +1,55 @@
+#include &lt;AK/Types.h&gt;
+#include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;sys/internals.h&gt;
+#include &lt;unistd.h&gt;
+
+extern &quot;C&quot; {
+
+extern u32 __stack_chk_guard;
+u32 __stack_chk_guard = (u32)0xc6c7c8c9;
+
+[[noreturn]] void __stack_chk_fail()
+{
+    dbgprintf(&quot;Error: Stack protector failure, stack smashing detected!\n&quot;);
+    if (__stdio_is_initialized)
+        fprintf(stderr, &quot;Error: Stack protector failure, stack smashing detected!\n&quot;);
+    abort();
+}
+
+[[noreturn]] void __stack_chk_fail_local()
+{
+    __stack_chk_fail();
+}
+
+} // extern &quot;C&quot;

diff --git a/Libraries/LibC/sys/internals.h b/Libraries/LibC/sys/internals.h
index 70443404e1..c23785a02e 100644
--- a/Libraries/LibC/sys/internals.h
+++ b/Libraries/LibC/sys/internals.h
@@ -43,5 +43,6 @@ 
 void __cxa_finalize(void* dso_handle);
 [[noreturn]] void __cxa_pure_virtual() __attribute__((weak));
 [[noreturn]] void __stack_chk_fail();
+[[noreturn]] void __stack_chk_fail_local();
 
 __END_DECLS
</code></pre>
<h2 id="getting-sidetracked-with-linking"><a class="header" href="#getting-sidetracked-with-linking">Getting Sidetracked with Linking</a></h2>
<p>Compiling again with the new <code>__stack_chk_fail_local</code> implementation available
in <code>LibC</code>, we surprisingly failed again with the same error. On closer inspection
it's actually slightly different, we successfully linked <code>LibC</code> but now we are
failing to link a different library <code>LibDiff</code> that depends on <code>LibC</code>:</p>
<pre><code>[334/1280] Linking CXX shared library Libraries/LibDiff/libdiff.so
FAILED: Libraries/LibDiff/libdiff.so
../Libraries/LibDiff/Hunks.cpp:113: undefined reference to `__stack_chk_fail_local'
../Libraries/LibC/stdlib.cpp:1062: undefined reference to `__stack_chk_fail_local'
</code></pre>
<p>I started debugging what was going on, so lets see what is ending up in the final
library. We can see that the <code>__stack_chk_fail_local</code> symbol is in the library but
notice the symbols flagged <code>l</code> instead of <code>g</code> like <code>__stack_chk_fail</code> is flagged:</p>
<pre><code class="language-bash">$ objdump -t Libraries/LibC/libc.so | rg __stack_chk_fail
0001ea58 l     F .text  00000015 __stack_chk_fail_local
0001ea08 g     F .text  00000050 __stack_chk_fail
</code></pre>
<p>The symbol table flags can be decoded using the <a href="https://www.man7.org/linux/man-pages/man1/objdump.1.html"><code>objdump(1)</code></a>
man page:</p>
<pre><code>The flag characters are divided into 7 groups as follows:

&quot;l&quot;
&quot;g&quot;
&quot;u&quot;
&quot;!&quot; The symbol is a local (l), global (g), unique global (u),
   neither global nor local (a space) or both global and
   local (!).  A symbol can be neither local or global for a
   variety of reasons, e.g., because it is used for
   debugging, but it is probably an indication of a bug if
   it is ever both local and global.  Unique global symbols
   are a GNU extension to the standard set of ELF symbol
   bindings.  For such a symbol the dynamic linker will make
   sure that in the entire process there is just one symbol
   with this name and type in use.
</code></pre>
<p>So somehow the <code>__stack_chk_fail_local</code> symbol is getting marked local (l) instead
of global (g) like most other symbols in the application. After researching around
online I ran across the <a href="https://www.openwall.com/lists/musl/2018/09/11/2">following thread</a>
which provides some useful insight into how the stack protector support is supposed
to be linked into applications when running on Linux:</p>
<pre><code class="language-http">Date: Tue, 11 Sep 2018 15:07:50 +0200
From: Szabolcs Nagy &lt;nsz@...t70.net&gt;
To: musl@...ts.openwall.com
Subject: Re: undefined reference to __stack_chk_fail_local (x86)

* Matias Fonzo &lt;selk@...gora.org&gt; [2018-09-11 09:27:45 -0300]:
&gt; Bootstrapping Dragora (distro) reflects an error trying to build the
&gt; kernel headers using musl 1.1.20:
&gt; 
&gt; Running build() ...
&gt;   UPD     include/generated/uapi/linux/version.h
&gt;   HOSTCC  scripts/basic/fixdep
&gt; /tmp/ccONBchp.o: In function `read_file':
&gt; fixdep.c:(.text+0x12a): undefined reference to `__stack_chk_fail_local'
&gt; /tmp/ccONBchp.o: In function `main':
&gt; fixdep.c:(.text.startup+0x6e2): undefined reference to
&gt; `__stack_chk_fail_local' /tools/lib32/gcc/i586-linux-musl/bin/ld:
&gt; scripts/basic/fixdep: hidden symbol `__stack_chk_fail_local' isn't
&gt; defined /tools/lib32/gcc/i586-linux-musl/bin/ld:
&gt; final link failed: Bad value collect2: error: ld returned 1 exit status
&gt; make[1]: *** [scripts/Makefile.host:90: scripts/basic/fixdep] Error 1
&gt; make: *** [Makefile:464: scripts_basic] Error 2 Return status = 2
&gt; 

this happens because on i386 and powerpc gcc emits _local_ calls
to __stack_chk_fail_local which means it has to be defined within
the same module that you are linking (not in libc.so).
(that symbol should either call the extern __stack_chk_fail in
libc.so or just crash)

this should have been done by libgcc.a having a definition for
this symbol (since the compiler is using it), but instead it got
added to glibc libc_nonshared.a which is added to the link command
by using a linker script in place of libc.so.

musl does not want to copy that hack, so the usual workaround is
to make gcc pass -lssp_nonshared to the linker when stack-protector
is in use and then have a libssp_nonshared.a with the appropriate
definition. (this is what alpine linux does)

you can also do this manually or disable ssp with -fno-stack-protector,
it may also work if a preincluded header declared it as weak
so undefined weak reference would just become 0 (and crash at runtime
which is the intended behaviour), but i havent tested that.
</code></pre>
<p>After reading this I modified the CMake changes I had made to include my new 
<code>spp.cpp</code> file into <strong>LibC</strong> to factor it out into it's own static library
that can be automatically inserted as a dependent library whenever LibC is linked:</p>
<pre><code class="language-diff">diff --git a/Libraries/LibC/CMakeLists.txt b/Libraries/LibC/CMakeLists.txt
index 3366957d5d..971880ca00 100644
--- a/Libraries/LibC/CMakeLists.txt
+++ b/Libraries/LibC/CMakeLists.txt
@@ -71,13 +71,21 @@ 
 )
 
+add_library(ssp STATIC ssp.cpp)
 set(SOURCES ${LIBC_SOURCES} ${AK_SOURCES} ${ELF_SOURCES})
 
 serenity_libc_static(LibCStatic c)
-target_link_libraries(LibCStatic crt0)
+target_link_libraries(LibCStatic crt0 ssp)
 add_dependencies(LibCStatic LibM)
 
 set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -static-libstdc++&quot;)
 serenity_libc(LibC c)
-target_link_libraries(LibC crt0)
+target_link_libraries(LibC crt0 ssp)
 add_dependencies(LibC LibM)
</code></pre>
<p>With these changes the system now compiles and links cleanly!</p>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p>Now that we have the system compiling, lets write test program to make sure we
can actually crash the program when a stack smash is detected. The program should
overwrite a buffer on the stack:</p>
<pre><code class="language-cpp">#include &lt;cstdio&gt;

static void smasher(char* string)
{
#pragma GCC diagnostic push
#pragma GCC diagnostic ignored &quot;-Warray-bounds&quot;
    for (int i = 0; i &lt; 256; i++) {
        string[i] = 'A';
    }
#pragma GCC diagnostic pop
}

static void stack_to_smash()
{
    char string[8] = {};
    smasher(string);
}

int main()
{
    puts(&quot;[+] Starting the stack smash...&quot;);
    stack_to_smash();
    puts(&quot;[+] Stack smash wasn't detected!&quot;);

    return 0;
}
</code></pre>
<p>If we compile this, and boot into serenity and run our program what happens? </p>
<pre><code>courage ~ $ ./user/Tests/LibC/stack-smash
[+] Starting the stack smash ...
[+] Stack smash wasn't detected!
</code></pre>
<p>Hrm... that's not good, what's going on? </p>
<p>After looking at the disassembly it's obvious, the <code>stack_to_smash()</code> call is being
completely in-lined and optimized out.</p>
<pre><code class="language-x86asm">$ objdump -M intel --disassemble=main Userland/Tests/LibC/stack-smash
Userland/Tests/LibC/stack-smash:     file format elf32-i386
00000510 &lt;main&gt;:
 510:   8d 4c 24 04             lea    ecx,[esp+0x4]
 514:   83 e4 f0                and    esp,0xfffffff0
 517:   ff 71 fc                push   DWORD PTR [ecx-0x4]
 51a:   55                      push   ebp
 51b:   89 e5                   mov    ebp,esp
 51d:   53                      push   ebx
 51e:   e8 82 00 00 00          call   5a5 &lt;__x86.get_pc_thunk.bx&gt;
 523:   81 c3 e5 13 00 00       add    ebx,0x13e5
 529:   51                      push   ecx
 52a:   83 ec 0c                sub    esp,0xc
 52d:   8d 83 a1 ee ff ff       lea    eax,[ebx-0x115f]
 533:   50                      push   eax
 534:   e8 97 ff ff ff          call   4d0 &lt;puts@plt&gt;
 539:   8d 83 c1 ee ff ff       lea    eax,[ebx-0x113f]
 53f:   89 04 24                mov    DWORD PTR [esp],eax
 542:   e8 89 ff ff ff          call   4d0 &lt;puts@plt&gt;
 547:   8d 65 f8                lea    esp,[ebp-0x8]
 54a:   31 c0                   xor    eax,eax
 54c:   59                      pop    ecx
 54d:   5b                      pop    ebx
 54e:   5d                      pop    ebp
 54f:   8d 61 fc                lea    esp,[ecx-0x4]
 552:   c3                      ret
</code></pre>
<p>We can add <code>__attribute__((noinline))</code> to our function definitions to instruct
the compiler to not inline calls to our test functions:</p>
<pre><code class="language-cpp">#include &lt;cstdio&gt;

// Note: Needs to be 'noline' so stack canary isn't optimized out.
static void __attribute__((noinline)) smasher(char* string)
{
#pragma GCC diagnostic push
#pragma GCC diagnostic ignored &quot;-Warray-bounds&quot;
    for (int i = 0; i &lt; 256; i++) {
        string[i] = 'A';
    }
#pragma GCC diagnostic pop
}

// Note: Needs to be 'noline' so stack canary isn't optimized out.
static void __attribute__((noinline)) stack_to_smash()
{
    char string[8] = {};
    smasher(string);
}

int main()
{
    puts(&quot;[+] Starting the stack smash...&quot;);
    stack_to_smash();
    puts(&quot;[+] Stack smash wasn't detected!&quot;);

    return 0;
}
</code></pre>
<p>After re-compiling we can see the compiler instrumentation in the binary now,
note the injected calls to <code>__stack_chk_fail_local</code> in the disassembly of <code>_ZL14stack_to_smashv</code>:</p>
<pre><code class="language-x86asm">$ objdump -M intel --disassemble=main Userland/Tests/LibC/stack-smash
Userland/Tests/LibC/stack-smash:     file format elf32-i386
00000690 &lt;main&gt;:
 690:   8d 4c 24 04             lea    ecx,[esp+0x4]
 694:   83 e4 f0                and    esp,0xfffffff0
 697:   ff 71 fc                push   DWORD PTR [ecx-0x4]
 69a:   55                      push   ebp
 69b:   89 e5                   mov    ebp,esp
 69d:   53                      push   ebx
 69e:   e8 87 00 00 00          call   72a &lt;__x86.get_pc_thunk.bx&gt;
 6a3:   81 c3 29 15 00 00       add    ebx,0x1529
 6a9:   51                      push   ecx
 6aa:   83 ec 0c                sub    esp,0xc
 6ad:   8d 83 1d ee ff ff       lea    eax,[ebx-0x11e3]
 6b3:   50                      push   eax
 6b4:   e8 67 ff ff ff          call   620 &lt;puts@plt&gt;
 6b9:   e8 1c 02 00 00          call   8da &lt;_ZL14stack_to_smashv&gt;
 6be:   8d 83 3d ee ff ff       lea    eax,[ebx-0x11c3]
 6c4:   89 04 24                mov    DWORD PTR [esp],eax
 6c7:   e8 54 ff ff ff          call   620 &lt;puts@plt&gt;
 6cc:   8d 65 f8                lea    esp,[ebp-0x8]
 6cf:   31 c0                   xor    eax,eax
 6d1:   59                      pop    ecx
 6d2:   5b                      pop    ebx
 6d3:   5d                      pop    ebp
 6d4:   8d 61 fc                lea    esp,[ecx-0x4]
 6d7:   c3                      ret

000008c6 &lt;_ZL7smasherPc&gt;:
 8c6:   55                      push   ebp
 8c7:   89 c2                   mov    edx,eax
 8c9:   b9 00 01 00 00          mov    ecx,0x100
 8ce:   b0 41                   mov    al,0x41
 8d0:   89 e5                   mov    ebp,esp
 8d2:   57                      push   edi
 8d3:   89 d7                   mov    edi,edx
 8d5:   f3 aa                   rep stos BYTE PTR es:[edi],al
 8d7:   5f                      pop    edi
 8d8:   5d                      pop    ebp
 8d9:   c3                      ret

000008da &lt;_ZL14stack_to_smashv&gt;:
 8da:   e8 41 00 00 00          call   920 &lt;__x86.get_pc_thunk.ax&gt;
 8df:   05 ed 12 00 00          add    eax,0x12ed
 8e4:   55                      push   ebp
 8e5:   89 e5                   mov    ebp,esp
 8e7:   53                      push   ebx
 8e8:   83 ec 14                sub    esp,0x14
 8eb:   8d 98 28 00 00 00       lea    ebx,[eax+0x28]
 8f1:   c7 45 ec 00 00 00 00    mov    DWORD PTR [ebp-0x14],0x0
 8f8:   c7 45 f0 00 00 00 00    mov    DWORD PTR [ebp-0x10],0x0
 8ff:   8b 03                   mov    eax,DWORD PTR [ebx]
 901:   89 45 f4                mov    DWORD PTR [ebp-0xc],eax
 904:   31 c0                   xor    eax,eax
 906:   8d 45 ec                lea    eax,[ebp-0x14]
 909:   e8 b8 ff ff ff          call   8c6 &lt;_ZL7smasherPc&gt;
 90e:   8b 45 f4                mov    eax,DWORD PTR [ebp-0xc]
 911:   2b 03                   sub    eax,DWORD PTR [ebx]
 913:   74 05                   je     91a &lt;_ZL14stack_to_smashv+0x40&gt;
 915:   e8 5a 00 00 00          call   974 &lt;__stack_chk_fail_local&gt;
 91a:   83 c4 14                add    esp,0x14
 91d:   5b                      pop    ebx
 91e:   5d                      pop    ebp
 91f:   c3                      ret
</code></pre>
<p>With these changes we can see the system catches the corruption as expected:</p>
<pre><code>courage ~ $ ./user/Tests/LibC/stack-smash
[+] Starting the stack smash ...
Error: Stack protector failure, stack smashing detected!
Shell: Job 1 (/usr/Tests/LibC/stack-smash) Aborted
</code></pre>
<h2 id="final-pr"><a class="header" href="#final-pr">Final PR</a></h2>
<p>The resulting pull request is here: 
<a href="https://github.com/SerenityOS/serenity/pull/4726">Build + LibC: Enable -fstack-protector-strong in user space</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../serenityos/2021-01-02.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../serenityos/2020-12-30.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../serenityos/2021-01-02.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../serenityos/2020-12-30.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
